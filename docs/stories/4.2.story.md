# Story 4.2: Add Conversation Search to Conversation List

## Status

Draft

## Story

**As a** user,
**I want to** search my conversations by participant name,
**so that** I can quickly find and navigate to specific conversations without scrolling.

## Acceptance Criteria

1. A search bar is displayed at the top of the Conversation List View.
2. Users can type into the search bar to filter conversations in real-time as they type.
3. Conversations are filtered by matching participant names (display names).
4. The search is case-insensitive.
5. The search works offline using locally cached conversation data.
6. The search bar can be cleared to show all conversations again.
7. When no results match the search query, an appropriate empty state is shown.
8. Search functionality does not impact the performance of the conversation list scrolling.

## Tasks / Subtasks

- [ ] Task 1: Add Search State to ConversationListViewModel (AC: 2, 3, 5)
  - [ ] Add @Published var searchText: String = "" to ConversationListViewModel
  - [ ] Add computed property filteredConversations: [Conversation]
  - [ ] Implement filtering logic: match searchText against participant display names
  - [ ] Make filtering case-insensitive using localizedCaseInsensitiveContains
  - [ ] Ensure filtering uses cached conversations for offline support
  - [ ] Return all conversations when searchText is empty
  - [ ] Add unit tests for search filtering logic

- [ ] Task 2: Create Search Bar UI Component (AC: 1, 6)
  - [ ] Add SwiftUI SearchTextField at top of ConversationListView
  - [ ] Bind search field to viewModel.searchText
  - [ ] Use native searchable() modifier for iOS standard search experience
  - [ ] Add placeholder text: "Search conversations"
  - [ ] Ensure search bar is always visible (not collapsible initially for MVP)
  - [ ] Add clear button to reset search
  - [ ] Style search bar to match iOS native patterns

- [ ] Task 3: Update ConversationListView to Use Filtered Results (AC: 2, 8)
  - [ ] Update ForEach loop to iterate over viewModel.filteredConversations instead of conversations
  - [ ] Ensure real-time updates as user types (no debouncing needed for MVP)
  - [ ] Verify scroll performance with search active
  - [ ] Maintain existing conversation row UI and behavior
  - [ ] Keep presence indicators working during search
  - [ ] Test with large conversation lists (50+ conversations)

- [ ] Task 4: Implement Empty Search State (AC: 7)
  - [ ] Detect when filteredConversations is empty due to search (not initial load)
  - [ ] Show empty state view: "No conversations found"
  - [ ] Include icon (magnifying glass with X)
  - [ ] Suggest clearing search or trying different terms
  - [ ] Distinguish from "no conversations at all" empty state
  - [ ] Style consistently with existing empty states

- [ ] Task 5: Handle Search with Group Chats (AC: 3)
  - [ ] For group chats: search matches if ANY participant name matches
  - [ ] For group chats: search matches group name if one exists
  - [ ] Test search with various group chat configurations
  - [ ] Ensure group chat title formatting doesn't break search
  - [ ] Verify search works with both named and unnamed groups

- [ ] Task 6: Testing (AC: All)
  - [ ] Unit test: Search filtering logic with various queries
  - [ ] Unit test: Case-insensitive matching
  - [ ] Unit test: Empty string returns all conversations
  - [ ] Manual test: Search bar UI updates in real-time
  - [ ] Manual test: Search works offline with cached data
  - [ ] Manual test: Empty state displays when no matches
  - [ ] Manual test: Search performance with 50+ conversations
  - [ ] Manual test: Search works for 1:1 and group chats
  - [ ] Manual test: Clear button resets search properly
  
  **Note:** This story will rely on manual testing for end-to-end validation. Integration tests are not required.

## Dev Notes

### Current Implementation Context

**ConversationListViewModel (Source: Story 2.1):**
- Already loads conversations from cache (SwiftData) for offline support
- Maintains userCache for display names
- Has getOtherParticipantName() method for getting conversation titles
- Conversations array is @Published for real-time updates

**Conversation Model:**
```swift
struct Conversation {
    let conversationId: String
    let participants: [String]  // Array of user IDs
    var lastMessageText: String?
    var lastMessageTimestamp: Date?
    let isGroupChat: Bool
    var groupName: String?
}
```

### Technical Requirements

**SwiftUI Search Patterns:**
[Source: docs/architecture/frontend-architecture.md#SwiftUI-Patterns]
- Use native `.searchable()` modifier for iOS 15+ standard search experience
- Bind search text to @Published property in ViewModel
- Implement computed property for filtered results

**State Management:**
[Source: docs/architecture/frontend-architecture.md#State-Management]
- Add searchText as @Published var in ConversationListViewModel
- Create computed property filteredConversations that derives from conversations
- No need for manual state synchronization

**Offline Support:**
[Source: docs/architecture/core-workflows.md#Offline-Functionality]
- Search must work with locally cached conversations (SwiftData)
- No network calls required for search functionality
- Filtering happens on in-memory array

### Search Algorithm

**Filtering Logic:**
```swift
var filteredConversations: [Conversation] {
    guard !searchText.isEmpty else {
        return conversations  // Show all when not searching
    }
    
    return conversations.filter { conversation in
        let conversationTitle = getOtherParticipantName(for: conversation)
        return conversationTitle.localizedCaseInsensitiveContains(searchText)
    }
}
```

**Matching Rules:**
- Case-insensitive matching
- Substring matching (partial matches allowed)
- For 1:1: Match against other participant's display name
- For groups with name: Match against group name
- For groups without name: Match against any participant's display name in the formatted title

### File Locations

[Source: docs/architecture/unified-project-structure.md]
```
ios-app/MessageAI/
  ├── ViewModels/
  │   └── ConversationListViewModel.swift (modify)
  └── Views/
      └── Conversations/
          └── ConversationListView.swift (modify)
```

### UI/UX Design

**Search Bar Placement:**
- At the top of ConversationListView
- Use native `.searchable()` modifier
- Placeholder: "Search conversations"
- Shows cancel button when active (iOS standard)

**Empty State:**
- Icon: SF Symbol "magnifyingglass.circle.fill" with gray color
- Text: "No conversations found"
- Subtext: "Try adjusting your search"
- Distinguish from initial empty state (no conversations at all)

### Performance Considerations

**Optimization:**
- Filtering is in-memory operation (very fast)
- No debouncing needed initially (can add if performance issues arise)
- SwiftUI automatically handles efficient re-renders
- Test with realistic conversation counts (50-100 conversations)

**Scalability:**
- Current approach works well up to ~500 conversations
- If performance degrades, consider debouncing search input
- For very large lists (1000+), could implement virtual scrolling

### Testing

[Source: docs/architecture/testing-strategy.md]
- Unit tests in MessageAITests/ConversationListViewModelTests.swift
- Test search filtering logic with various scenarios
- Mock conversation data with known participant names
- **Manual Testing Focus:** This story will be validated primarily through manual testing
- Integration tests are not required - focus on unit tests for search logic and manual verification

**Test Scenarios:**
- Empty search string returns all conversations
- Search "john" matches conversations with participant "John Doe"
- Search "JoHn" (mixed case) still matches "John Doe"
- Search "xyz" with no matches shows empty state
- Group chat named "Team" matches search "team"
- Group chat with participant "Alice" matches search "alice"

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story draft for post-MVP conversation search feature | Bob (SM) |

## Dev Agent Record

### Agent Model Used

*To be filled by Dev Agent*

### Debug Log References

*To be filled by Dev Agent*

### Completion Notes List

*To be filled by Dev Agent*

### File List

*To be filled by Dev Agent*

## QA Results

*To be filled by QA Agent*

