# Story 1.3: Existing User Login & Logout

## Status

Draft

## Story

**As an** existing user,
**I want** to log in and log out of my account,
**so that** I can access my messages securely.

## Acceptance Criteria

1. A user can access a login screen.
2. A user can log in using their existing Firebase Auth credentials.
3. Upon successful login, the user is navigated to the main app (e.g., Conversation List View).
4. If login fails (e.g., wrong password), a clear error message is displayed.
5. A logged-in user can find a "Logout" button (e.g., in the Settings View).
6. Tapping "Logout" signs the user out of Firebase Auth and navigates them back to the login screen.

## Tasks / Subtasks

- [ ] Task 1: Extend AuthService with Login and Logout Methods (AC: 2, 6)
  - [ ] Add `signIn(email: String, password: String) async throws -> User` method to AuthService
  - [ ] Implement using Firebase Auth SDK `Auth.auth().signIn(withEmail:password:)`
  - [ ] Add `signOut() throws` method to AuthService
  - [ ] Implement using Firebase Auth SDK `try Auth.auth().signOut()`
  - [ ] Update @Published `currentUser` property on sign-in success and set to nil on sign-out
  - [ ] Implement error handling with user-friendly messages for auth failures
  - [ ] Add unit tests in `ios-app/MessageAITests/AuthServiceTests.swift` for new methods

- [ ] Task 2: Extend AuthViewModel with Login and Logout Flows (AC: 2, 4, 6)
  - [ ] Add `signIn(email: String, password: String)` method to AuthViewModel
  - [ ] Coordinate AuthService.signIn() call
  - [ ] Update @Published error state for UI error display (AC: 4)
  - [ ] Add @Published `isLoading` property for loading state
  - [ ] Add `signOut()` method to AuthViewModel
  - [ ] Call AuthService.signOut() and handle any errors
  - [ ] Add unit tests in `ios-app/MessageAITests/AuthViewModelTests.swift`

- [ ] Task 3: Create Login View UI (AC: 1, 2, 4)
  - [ ] Create `ios-app/MessageAI/Views/Auth/LoginView.swift`
  - [ ] Implement SwiftUI form with email TextField and password SecureField
  - [ ] Add "Log In" Button that calls AuthViewModel.signIn()
  - [ ] Add validation for email format and password requirements
  - [ ] Display error alerts for login failures (AC: 4)
  - [ ] Add loading state with disabled button and spinner during authentication
  - [ ] Use native SwiftUI components for consistent iOS look and feel
  - [ ] Add SwiftUI Preview for UI testing
  - [ ] Add accessibility labels for VoiceOver support

- [ ] Task 4: Create Settings View with Logout Button (AC: 5, 6)
  - [ ] Create `ios-app/MessageAI/Views/Settings/SettingsView.swift`
  - [ ] Add "Logout" Button in Settings View (AC: 5)
  - [ ] Button calls AuthViewModel.signOut() (AC: 6)
  - [ ] Add confirmation alert before logout (optional but recommended UX)
  - [ ] Use native SwiftUI List and Button components
  - [ ] Add SwiftUI Preview
  - [ ] Add accessibility support

- [ ] Task 5: Update Navigation Routing for Login/Logout Flow (AC: 1, 3, 6)
  - [ ] Update `ios-app/MessageAI/MessageAIApp.swift` root view to show LoginView when not authenticated
  - [ ] Create auth routing logic: If currentUser is nil → show LoginView, else → show ConversationListView
  - [ ] Ensure navigation to main app on successful login (AC: 3)
  - [ ] Ensure navigation back to LoginView on logout (AC: 6)
  - [ ] Add navigation to Settings View from ConversationListView (toolbar button or navigation link)

- [ ] Task 6: Add Link Between Sign-Up and Login Screens (AC: 1)
  - [ ] Update SignUpView to add "Already have an account? Log In" button at bottom
  - [ ] Button navigates to LoginView
  - [ ] Update LoginView to add "Don't have an account? Sign Up" button at bottom
  - [ ] Button navigates to SignUpView
  - [ ] Ensure navigation uses NavigationLink or programmatic navigation

- [ ] Task 7: Integration Testing (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create integration test in `ios-app/MessageAITests/LoginFlowTests.swift`
  - [ ] Test complete login flow: UI → ViewModel → AuthService → Firebase
  - [ ] Test navigation to main app on success (AC: 3)
  - [ ] Test error scenarios (wrong password, invalid email, network errors) (AC: 4)
  - [ ] Test logout flow: Settings → Logout → Navigate back to LoginView (AC: 5, 6)
  - [ ] Verify currentUser state updates correctly

## Dev Notes

### Previous Story Insights

**PREREQUISITE: Story 1.2 (Project Reorganization) must be completed first!**

From Story 1.1 & 1.2:
- ✅ **AuthService exists** at `ios-app/MessageAI/Services/AuthService.swift` with sign-up capability
- ✅ **FirestoreService exists** at `ios-app/MessageAI/Services/FirestoreService.swift` (no changes needed for this story)
- ✅ **AuthViewModel exists** at `ios-app/MessageAI/ViewModels/AuthViewModel.swift` - extend with login/logout methods
- ✅ **Auth-based navigation routing** already implemented in `ios-app/MessageAI/MessageAIApp.swift` - update to show LoginView
- ✅ **Firebase SDK integrated**: FirebaseAuth, FirebaseFirestore, FirebaseFirestoreSwift
- ✅ **SignUpView exists** at `ios-app/MessageAI/Views/Auth/SignUpView.swift` - add navigation link to LoginView
- ✅ **ConversationListView exists** as main app placeholder - add navigation to Settings
- ✅ **Project structure**: After Story 1.2, all files are in proper monorepo structure at `ios-app/MessageAI/`

### UI/UX Specification

**IMPORTANT**: UI/UX spec at `docs/front-end-spec.md` currently only covers Sign-Up screen (Story 1.1). Login/Logout UI specifications are not yet defined.

**Design Guidance for This Story:**
- Follow same design patterns as Sign-Up screen for consistency
- Use native SwiftUI components (TextField, SecureField, Button, Alert)
- Apply same validation patterns (real-time validation with debouncing)
- Use same color palette and typography from Sign-Up screen
- Implement full accessibility support (VoiceOver, Dynamic Type, Reduce Motion)
- Follow iOS native aesthetic (system colors, SF Pro font, SF Symbols)

**Login Screen Design:**
- Single-screen form with Email + Password fields
- "Log In" button (primary action)
- "Don't have an account? Sign Up" link at bottom
- Password show/hide toggle (eye icon inside field, trailing position)
- Real-time validation with debouncing (300ms)
- Error alerts for authentication failures
- Loading state with spinner on button

**Settings Screen Design:**
- Native iOS List-based layout
- "Logout" button in destructive red color
- Optional: Confirmation alert "Are you sure you want to logout?"
- Accessible via toolbar button from ConversationListView

### Architecture Context

**Tech Stack** [Source: architecture/tech-stack.md]
- Frontend: Swift 5.9+, SwiftUI (Latest), Native SwiftUI Components
- State Management: SwiftUI built-in (@State, @StateObject, @ObservedObject, @EnvironmentObject)
- Authentication: Firebase Auth (Cloud)
- Testing: XCTest for unit/UI testing

**Project Structure** [Source: architecture/unified-project-structure.md]
```
MessageAI/                  # Root
├── ios-app/                 # Xcode Project
│   ├── MessageAI/           # Source code
│   │   ├── MessageAIApp.swift      # App entry point with auth routing
│   │   ├── Models/                  # User.swift, UserEntity.swift
│   │   ├── Views/                   # Auth/, Conversations/, Settings/
│   │   ├── ViewModels/              # AuthViewModel.swift
│   │   ├── Services/                # AuthService.swift, FirestoreService.swift
│   │   └── Persistence/             # PersistenceController.swift
│   ├── MessageAI.xcodeproj
│   └── MessageAITests/
└── docs/                    # Documentation
```

**Authentication Flow** [Source: architecture/authentication-and-authorization.md#Auth-Flow]

**Login Flow:**
1. User enters credentials, taps Log In
2. App calls AuthViewModel.signIn()
3. AuthViewModel calls AuthService.signIn()
4. AuthService calls Firebase Auth SDK `Auth.auth().signIn(withEmail:password:)`
5. Firebase Auth verifies credentials
6. On success: AuthService updates currentUser, App navigates to main view
7. On failure: AuthService returns error, App displays error alert to user

**Logout Flow:**
1. User taps Logout in Settings
2. App calls AuthViewModel.signOut()
3. AuthViewModel calls AuthService.signOut()
4. AuthService calls `Auth.auth().signOut()`
5. AuthService sets currentUser to nil
6. App detects nil currentUser and navigates to LoginView

**Component Architecture** [Source: architecture/frontend-architecture.md#Component-Architecture]
- Pattern: MVVM (Model-View-ViewModel)
- Views: SwiftUI views in `Views/` directory, organized by feature
- ViewModels: ObservableObjects with @Published properties
- Services: Firebase SDK wrappers (AuthService)
- Dependency Injection: Services injected into ViewModels

**AuthService Extension** [Source: architecture/frontend-architecture.md#API-Client-Setup]
```swift
// Extend existing AuthService with:
class AuthService: ObservableObject {
    @Published var currentUser: User?
    
    // Existing from Story 1.1:
    func signUp(email: String, password: String) async throws -> User { /* ... */ }
    
    // NEW for Story 1.2:
    func signIn(email: String, password: String) async throws -> User {
        let result = try await Auth.auth().signIn(withEmail: email, password: password)
        // Fetch user from Firestore or create User object
        // Update currentUser
        return user
    }
    
    func signOut() throws {
        try Auth.auth().signOut()
        currentUser = nil
    }
}
```

**State Management** [Source: architecture/frontend-architecture.md#State-Management-Architecture]
- Use SwiftUI built-in property wrappers (@State, @StateObject, @ObservedObject, @EnvironmentObject)
- AuthViewModel exposes authentication state via @Published properties
- AuthService.currentUser is the single source of truth for auth state
- No external state management libraries needed for MVP

**Routing** [Source: architecture/frontend-architecture.md#Routing-Architecture]
- Use NavigationStack (iOS 16+)
- Root view checks auth state: `if AuthService.currentUser == nil` → show LoginView, else → show main app
- Protected Route Pattern: Conditionally render based on AuthService.currentUser state
- Navigation between SignUpView and LoginView: Use NavigationLink or programmatic navigation
- Settings View: Accessible via toolbar button from ConversationListView

**Error Handling** [Source: architecture/error-handling-strategy.md#Frontend-Error-Handling]
- Use do-catch for async service calls
- ViewModels catch errors, log using OSLog
- Update @Published error state for UI display
- Display user-friendly error messages via Alert
- **Login Error Messages:**
  - Invalid email: "Please enter a valid email address"
  - Wrong password: "Incorrect email or password"
  - User not found: "No account found with this email"
  - Too many attempts: "Too many login attempts. Please try again later"
  - Network error: "Connection failed. Please check your internet and try again"

**Coding Standards** [Source: architecture/coding-standards.md]
- Files: PascalCase (e.g., `LoginView.swift`, `SettingsView.swift`)
- Classes/Structs: PascalCase (e.g., `AuthViewModel`)
- Functions/Methods: camelCase (e.g., `signIn()`, `signOut()`)
- Variables: camelCase (e.g., `currentUser`, `isLoading`)
- Use official Firebase SDKs
- Consistent error handling: Swift do-catch patterns
- SwiftUI property wrappers for state management

**Firebase Auth Methods** [Source: architecture/components.md#Firebase-Authentication]
- Sign In: `Auth.auth().signIn(withEmail: String, password: String) async throws -> AuthDataResult`
- Sign Out: `try Auth.auth().signOut()`
- Current User: `Auth.auth().currentUser` (optional FirebaseAuth.User)

**Security Considerations** [Source: architecture/security-and-performance.md]
- Never store passwords in local cache
- Use Firebase Auth for secure credential handling
- Email validation on client side for better UX, server-side validation by Firebase Auth
- Firestore Security Rules restrict user data access

### Testing

**Testing Standards** [Source: architecture/testing-strategy.md]

**Test Organization:**
- Unit tests location: `ios-app/MessageAITests/`
- UI tests location: `ios-app/MessageAIUITests/` (if needed)

**Frontend Testing:**
- Framework: XCTest (Native iOS testing framework)
- Unit tests for AuthViewModel: Mock AuthService, test business logic
- Unit tests for AuthService: Test sign-in and sign-out methods with Firebase SDK
- UI tests: XCUITest for end-to-end login/logout flows (optional for MVP)
- Test naming convention: `test{MethodName}_{Scenario}_{ExpectedResult}`
- Example: `testSignIn_WithValidCredentials_NavigatesToMainApp()`

**Testing Requirements for This Story:**

1. **AuthService unit tests** (extend existing AuthServiceTests.swift):
   - Test successful sign-in with valid credentials
   - Test sign-in with invalid email
   - Test sign-in with wrong password
   - Test sign-in with non-existent user
   - Test network error handling
   - Test successful sign-out
   - Test currentUser state updates on sign-in/sign-out

2. **AuthViewModel unit tests** (extend existing AuthViewModelTests.swift):
   - Test sign-in flow coordination
   - Test error state updates for login failures
   - Test loading state during sign-in
   - Test sign-out flow
   - Mock AuthService for unit tests

3. **Integration tests** (create LoginFlowTests.swift):
   - Test complete login flow from UI to Firebase
   - Test navigation to main app on success
   - Test logout flow from Settings
   - Test navigation back to LoginView after logout
   - Test error scenarios with real Firebase Auth (or emulator)

4. **UI tests** (optional for MVP):
   - Test login screen displays correctly
   - Test form validation
   - Test error message display
   - Test logout button in Settings

**Test Examples:**
```swift
// Example unit test structure
import XCTest
@testable import MessageAI

final class AuthServiceTests: XCTestCase {
    var authService: AuthService!
    
    override func setUp() {
        super.setUp()
        authService = AuthService()
    }
    
    func testSignIn_WithValidCredentials_ReturnsUser() async throws {
        // Arrange
        let email = "test@example.com"
        let password = "SecurePass123"
        
        // Act
        let user = try await authService.signIn(email: email, password: password)
        
        // Assert
        XCTAssertNotNil(user)
        XCTAssertEqual(user.email, email)
        XCTAssertNotNil(authService.currentUser)
    }
    
    func testSignOut_WhenCalled_ClearsCurrentUser() throws {
        // Arrange
        // Assume user is signed in
        
        // Act
        try authService.signOut()
        
        // Assert
        XCTAssertNil(authService.currentUser)
    }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation for Login & Logout | SM Agent (Bob) |
| 2025-10-21 | 1.1 | Renumbered from 1.2 to 1.3 (project reorganization moved to 1.2) | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_

