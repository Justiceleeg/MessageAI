# Story 1.3: User Theme Selection

## Status

Approved

## Story

**As a** user,
**I want** to change my app's theme,
**so that** it matches my visual preference (light, dark, or system default).

## Acceptance Criteria

1. A "Settings View" is accessible from the main app.
2. The app, by default, respects the system's Light or Dark Mode.
3. The "Settings View" provides three options: "System Default," "Light," and "Dark."
4. Selecting "Light" forces the app into Light Mode, regardless of the system setting.
5. Selecting "Dark" forces the app into Dark Mode, regardless of the system setting.
6. Selecting "System Default" reverts the app to respecting the system's setting.
7. The user's choice is persisted and applied on the next app launch.

## Tasks / Subtasks

- [ ] Task 1: Create Theme Preference Model (AC: 7)
  - [ ] Create enum `ThemePreference` in `ios-app/MessageAI/Models/ThemePreference.swift`
  - [ ] Define cases: `.system`, `.light`, `.dark`
  - [ ] Make enum Codable for UserDefaults persistence
  - [ ] Add raw value mapping for storage

- [ ] Task 2: Create ThemeManager Service (AC: 2, 4, 5, 6, 7)
  - [ ] Create `ios-app/MessageAI/Services/ThemeManager.swift`
  - [ ] Implement ThemeManager as ObservableObject
  - [ ] Add @Published property `currentTheme: ThemePreference` with default value `.system`
  - [ ] Implement persistence using UserDefaults with key "userThemePreference"
  - [ ] Implement `loadThemePreference()` method to load from UserDefaults on app launch
  - [ ] Implement `setTheme(_ theme: ThemePreference)` method to save to UserDefaults
  - [ ] Add computed property `preferredColorScheme: ColorScheme?` that returns:
    - `nil` for `.system` (respects system setting)
    - `.light` for `.light`
    - `.dark` for `.dark`
  - [ ] Add unit tests in `ios-app/MessageAITests/ThemeManagerTests.swift`

- [ ] Task 3: Integrate Theme Manager into App (AC: 2, 4, 5, 6, 7)
  - [ ] Update `ios-app/MessageAI/MessageAIApp.swift`
  - [ ] Create @StateObject for ThemeManager
  - [ ] Inject ThemeManager into environment
  - [ ] Apply `.preferredColorScheme()` modifier to root view based on ThemeManager.preferredColorScheme
  - [ ] Call ThemeManager.loadThemePreference() on app initialization

- [ ] Task 4: Add Theme Selection UI to Settings View (AC: 1, 3, 4, 5, 6)
  - [ ] Update existing `ios-app/MessageAI/Views/Settings/SettingsView.swift` (from Story 1.2)
  - [ ] Add "Appearance" section to settings list
  - [ ] Add Picker or List with three options:
    - "System Default" (ThemePreference.system)
    - "Light" (ThemePreference.light)
    - "Dark" (ThemePreference.dark)
  - [ ] Bind selection to ThemeManager.currentTheme
  - [ ] Add SF Symbol icons for each option: `gear.badge` (system), `sun.max` (light), `moon` (dark)
  - [ ] Display currently selected theme with checkmark
  - [ ] Follow native iOS Settings app design patterns
  - [ ] Use NavigationLink for theme selection (drill-down pattern) or inline Picker
  - [ ] Ensure theme change applies immediately in the UI
  - [ ] Update SwiftUI Preview to show theme selection UI

- [ ] Task 5: Visual Testing and Validation (AC: 2, 4, 5, 6, 7)
  - [ ] Test default behavior: App respects system theme on first launch
  - [ ] Test Light mode selection: App switches to light mode and persists choice
  - [ ] Test Dark mode selection: App switches to dark mode and persists choice
  - [ ] Test System Default selection: App reverts to system setting
  - [ ] Test persistence: Close and reopen app, verify theme preference is maintained
  - [ ] Test all UI screens in all three theme modes (Login, Sign-Up, Settings, Conversation List)
  - [ ] Verify semantic colors adapt correctly (system background, labels, etc.)

- [ ] Task 6: Unit Testing (AC: 2, 4, 5, 6, 7)
  - [ ] Create unit tests in `ios-app/MessageAITests/ThemeManagerTests.swift`
  - [ ] Test theme preference persistence to UserDefaults
  - [ ] Test theme preference loading from UserDefaults
  - [ ] Test `preferredColorScheme` computed property returns correct values
  - [ ] Test default value is `.system`
  - [ ] Test setting theme updates @Published property
  - [ ] Mock UserDefaults for isolated testing

## Dev Notes

### Previous Story Insights

**From Story 1.1:**
- Firebase SDK integrated (Auth, Firestore)
- User models created (User, UserEntity)
- SwiftData persistence layer configured
- Auth-based navigation routing established
- Testing infrastructure with XCTest established

**From Story 1.2:**
- Settings View created with logout functionality
- Navigation from Conversation List to Settings established
- Auth flows (login/logout) implemented
- Settings View uses List-based layout

**Key Technical Foundation Built:**
✓ Settings View exists (from Story 1.2)  
✓ Navigation to Settings working  
✓ Service layer pattern established (AuthService, FirestoreService)  
✓ Environment injection pattern established  

**This Story Extends:**
- Settings View: Add "Appearance" section with theme selection
- App Entry Point: Add ThemeManager, apply color scheme
- Services: New ThemeManager for theme persistence

### UI/UX Specification

**IMPORTANT**: Complete UI/UX design specification available at: `docs/front-end-spec.md`

**Settings Screen Theme Selection Design:**
- Add "Appearance" section in Settings List (above or below Account section)
- Use NavigationLink drill-down pattern (tap "Appearance" → navigate to theme selection screen) OR inline Picker
- Theme selection screen layout:
  - Title: "Appearance"
  - List with three rows:
    1. "System Default" with `gear.badge` SF Symbol
    2. "Light" with `sun.max` SF Symbol
    3. "Dark" with `moon` SF Symbol
  - Show checkmark (`.listRowTrailingSwipeActionsConfiguration` or `.listStyle`) for selected theme
- Native iOS Settings app aesthetic
- Immediate theme change when option is tapped (no "Save" button needed)
- All spacing follows 8pt grid system
- Accessibility: Each option has VoiceOver label indicating current selection

**Drill-down vs Inline Picker:**
- **Drill-down** (recommended for iOS): Tap "Appearance" row → navigate to new screen with 3 options
- **Inline Picker**: Show Picker directly in Settings list (more compact but less iOS-native)
- Recommend drill-down for consistency with iOS Settings app patterns

**Key UI Decisions:**
- Follow native iOS Settings patterns for familiarity
- Immediate visual feedback when theme changes
- Clear iconography for each theme option
- Persistent selection indicated with checkmark

### Architecture Context

**Tech Stack** [Source: architecture/tech-stack.md]
- Frontend: Swift 5.9+, SwiftUI (Latest), Native SwiftUI Components
- State Management: SwiftUI built-in (@State, @StateObject, @ObservedObject, @EnvironmentObject)
- Local Persistence: UserDefaults for lightweight key-value storage
- Testing: XCTest for unit/UI testing

**Project Structure** [Source: architecture/unified-project-structure.md]
```
ios-app/
├── MessageAI/
│   ├── Models/          # ThemePreference.swift (NEW)
│   ├── Views/
│   │   ├── Settings/    # SettingsView.swift (UPDATE), ThemeSelectionView.swift (NEW, optional)
│   ├── Services/        # ThemeManager.swift (NEW)
│   └── MessageAIApp.swift (UPDATE)
├── MessageAI.xcodeproj
└── MessageAITests/      # ThemeManagerTests.swift (NEW)
```

**Data Models**

ThemePreference Enum:
```swift
enum ThemePreference: String, Codable {
    case system = "system"
    case light = "light"
    case dark = "dark"
}
```

**Theme Management Architecture**

ThemeManager Service Template:
```swift
import SwiftUI

class ThemeManager: ObservableObject {
    @Published var currentTheme: ThemePreference = .system
    
    private let userDefaultsKey = "userThemePreference"
    
    init() {
        loadThemePreference()
    }
    
    func loadThemePreference() {
        if let savedTheme = UserDefaults.standard.string(forKey: userDefaultsKey),
           let theme = ThemePreference(rawValue: savedTheme) {
            currentTheme = theme
        }
    }
    
    func setTheme(_ theme: ThemePreference) {
        currentTheme = theme
        UserDefaults.standard.set(theme.rawValue, forKey: userDefaultsKey)
    }
    
    var preferredColorScheme: ColorScheme? {
        switch currentTheme {
        case .system: return nil  // Respects system setting
        case .light: return .light
        case .dark: return .dark
        }
    }
}
```

**SwiftUI ColorScheme Integration:**
- Use `.preferredColorScheme()` modifier on root view
- Pass `nil` to respect system setting
- Pass `.light` or `.dark` to override system setting
- SwiftUI automatically propagates color scheme to all child views

**Persistence Strategy:**
- Use UserDefaults for simple theme preference storage
- No need for SwiftData or Firestore (local-only preference)
- UserDefaults is appropriate for lightweight user settings
- Key-value storage with string-based enum raw values

**State Management** [Source: architecture/frontend-architecture.md#State-Management-Architecture]
- ThemeManager as ObservableObject with @Published properties
- Inject ThemeManager into environment using `.environmentObject()`
- Views access ThemeManager using `@EnvironmentObject`
- Theme change triggers UI updates via Combine publishers

**Routing**
- No routing changes needed (Settings View already exists from Story 1.2)
- Optional: Create separate ThemeSelectionView for drill-down pattern
- Use NavigationLink from Settings to ThemeSelectionView

**Error Handling**
- UserDefaults operations typically don't fail
- Handle case where saved theme doesn't exist (first launch) → default to `.system`
- No Firebase errors to handle (local-only feature)

**Coding Standards** [Source: architecture/coding-standards.md]
- Files: PascalCase (e.g., `ThemeManager.swift`, `ThemePreference.swift`)
- Enums: PascalCase (e.g., `ThemePreference`)
- Enum cases: camelCase (e.g., `.system`, `.light`, `.dark`)
- Functions/Methods: camelCase (e.g., `setTheme()`, `loadThemePreference()`)
- UserDefaults keys: camelCase string constants

**SwiftUI Color Scheme Best Practices:**
- Use semantic colors (Color.primary, Color.secondary, Color.background) throughout app
- Semantic colors automatically adapt to light/dark mode
- Test all screens in both light and dark modes
- Ensure sufficient contrast for accessibility (WCAG AA compliance)

### Testing

**Testing Standards** [Source: architecture/testing-strategy.md]

**Test Organization:**
- Unit tests location: `ios-app/MessageAITests/`
- UI tests location: `ios-app/MessageAIUITests/`

**Frontend Testing:**
- Framework: XCTest (Native iOS testing framework)
- Unit tests for ThemeManager: Test persistence, loading, computed properties
- UI tests: Visual validation of theme changes across screens
- Test naming convention: `test{MethodName}_{Scenario}_{ExpectedResult}`

**Testing Requirements for This Story:**

1. **ThemeManager unit tests:**
   - Test default theme is `.system`
   - Test setting theme to `.light` persists to UserDefaults
   - Test setting theme to `.dark` persists to UserDefaults
   - Test setting theme to `.system` persists to UserDefaults
   - Test loading theme from UserDefaults on initialization
   - Test `preferredColorScheme` returns `nil` for `.system`
   - Test `preferredColorScheme` returns `.light` for `.light`
   - Test `preferredColorScheme` returns `.dark` for `.dark`
   - Test behavior when UserDefaults has no saved value (first launch)
   - Mock UserDefaults for isolated testing

2. **Integration tests:**
   - Test theme selection in Settings updates ThemeManager
   - Test theme persists after app restart (requires app lifecycle testing)
   - Test UI responds to theme changes (visual validation)
   - Test all screens display correctly in light mode
   - Test all screens display correctly in dark mode
   - Test all screens display correctly in system mode

3. **Manual testing checklist:**
   - [ ] First launch: App respects system theme
   - [ ] Select Light theme: App switches to light mode
   - [ ] Close and reopen app: Light mode is still active
   - [ ] Switch to Dark theme: App switches to dark mode immediately
   - [ ] Switch to System Default: App respects device theme setting
   - [ ] Change device theme (iOS Settings): App responds when System Default is selected
   - [ ] Verify all screens (Login, Sign-Up, Conversation List, Settings) look correct in both modes

**Test Example:**
```swift
// Example unit test structure
import XCTest
@testable import MessageAI

final class ThemeManagerTests: XCTestCase {
    var themeManager: ThemeManager!
    var mockDefaults: UserDefaults!
    
    override func setUp() {
        super.setUp()
        // Use separate UserDefaults suite for testing
        mockDefaults = UserDefaults(suiteName: "TestDefaults")!
        mockDefaults.removePersistentDomain(forName: "TestDefaults")
        themeManager = ThemeManager(userDefaults: mockDefaults)
    }
    
    override func tearDown() {
        mockDefaults.removePersistentDomain(forName: "TestDefaults")
        super.tearDown()
    }
    
    func testDefaultTheme_IsSystem() {
        // Assert
        XCTAssertEqual(themeManager.currentTheme, .system)
    }
    
    func testSetTheme_Light_PersistsToUserDefaults() {
        // Act
        themeManager.setTheme(.light)
        
        // Assert
        XCTAssertEqual(themeManager.currentTheme, .light)
        let savedTheme = mockDefaults.string(forKey: "userThemePreference")
        XCTAssertEqual(savedTheme, "light")
    }
    
    func testPreferredColorScheme_SystemTheme_ReturnsNil() {
        // Arrange
        themeManager.setTheme(.system)
        
        // Act
        let colorScheme = themeManager.preferredColorScheme
        
        // Assert
        XCTAssertNil(colorScheme)
    }
    
    func testPreferredColorScheme_LightTheme_ReturnsLight() {
        // Arrange
        themeManager.setTheme(.light)
        
        // Act
        let colorScheme = themeManager.preferredColorScheme
        
        // Assert
        XCTAssertEqual(colorScheme, .light)
    }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation | SM Agent (Claude) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_

