# Story 5.1: Smart Calendar Extraction

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 4  
**Priority:** High  
**Assigned To:** @dev  
**Status:** Not Started

---

## User Story

**As a** busy person coordinating plans with friends,  
**I want** the app to detect calendar events in my messages and help me create them,  
**so that** I don't have to manually track dates and times from conversations.

---

## Description

When a user sends a message containing a calendar event (date, time, location), the AI automatically detects it and displays an "➕ Add to calendar?" button below their message bubble. Clicking opens a modal where the user can review and confirm the extracted details before adding it to their calendar.

This feature uses OpenAI GPT-4o-mini to extract structured event data from natural language, generates embeddings for event deduplication using vector search, and stores events in Firestore for real-time sync.

---

## Acceptance Criteria

### AC1: Message Analysis Detects Events
- [ ] AI analyzes outgoing messages after they're sent
- [ ] Detects date references: "tomorrow", "Friday", "Oct 25", "next week"
- [ ] Detects time references: "3pm", "at 7:00", "noon", "morning"
- [ ] Detects location: "at Coffee Place", "my house", addresses
- [ ] Extracts event title from context: "dinner", "meeting", "party"
- [ ] Returns structured JSON with event details

### AC2: AI Prompt Displayed
- [ ] "➕ Add to calendar?" button appears below user's message
- [ ] Button only shows if calendar event detected
- [ ] Button positioned below message bubble (not inline)
- [ ] Button has gentle, non-intrusive styling
- [ ] Multiple AI prompts can appear on same message (e.g., event + reminder)

### AC3: Event Creation Modal
- [ ] Tapping button opens modal
- [ ] Modal pre-fills with AI-extracted data:
  - Title (editable text field)
  - Date (date picker, default to extracted date)
  - Time (time picker, optional)
  - Location (editable text field, optional)
- [ ] "Cancel" button dismisses modal
- [ ] "Create Event" button validates and saves
- [ ] Modal uses native iOS design patterns

### AC4: Event Stored in Firestore
- [ ] Event document created in `events` collection
- [ ] Schema matches technical spec:
  ```
  - id, title, date, time, location
  - creatorUserId, createdAt
  - createdInConversationId, createdAtMessageId
  - invitations: {} (empty for now)
  - attendees: {userId: {status: "pending"}} (creator)
  ```
- [ ] Event saved with proper user permissions
- [ ] Real-time listeners update calendar view

### AC5: Vector Embedding Generated
- [ ] iOS calls backend: `POST /events/create`
- [ ] Backend generates embedding for event title + date
- [ ] Embedding stored in Pinecone namespace "events"
- [ ] Metadata includes: eventId, title, date, userId
- [ ] Embedding used for future deduplication

### AC6: Event Deduplication (Basic)
- [ ] Before creating event, search Pinecone for similar events
- [ ] If similarity > 0.85, show modal: "Link to existing event?"
- [ ] Options: "Yes, link" or "No, create new"
- [ ] If link: Add to existing event's invitations
- [ ] If new: Create separate event
- [ ] Simple matching for MVP (title + date similarity)

### AC7: Message Linking
- [ ] Event stores `createdAtMessageId` reference
- [ ] From calendar view, user can navigate to creation message
- [ ] Tapping event → Event details → "Jump to Message" button
- [ ] Navigates to conversation, scrolls to message
- [ ] Message briefly highlighted

### AC8: Error Handling
- [ ] If backend unavailable, no AI prompt shown (silent failure)
- [ ] If event creation fails, show error: "Failed to create event. Try again?"
- [ ] Network errors handled gracefully
- [ ] Offline: No AI analysis (existing offline queue still works)

---

## Tasks

### Task 1: Backend - Analysis Endpoint (AC1, AC5)
- [ ] Create `POST /api/v1/analyze-message` endpoint
- [ ] Accept: message_text, conversation_id, user_id, user_calendar
- [ ] Use GPT-4o-mini with structured prompt
- [ ] Extract calendar, decision, priority, rsvp, reminder, conflict
- [ ] Return JSON with all detections
- [ ] Generate embedding for message
- [ ] Store in Pinecone namespace "messages"

### Task 2: Backend - Event Creation (AC4, AC5, AC6)
- [ ] Create `POST /api/v1/events/create` endpoint
- [ ] Accept: title, date, time, location, userId
- [ ] Generate event embedding (title + date)
- [ ] Search Pinecone for similar events (cosine similarity)
- [ ] If similarity > 0.85, return suggestion to link
- [ ] Otherwise, return success
- [ ] Store embedding in Pinecone namespace "events"

### Task 3: Backend - Event Search (AC6)
- [ ] Create `GET /api/v1/events/search` endpoint
- [ ] Accept: userId, query, k (default 3)
- [ ] Use Pinecone similarity search
- [ ] Filter by userId
- [ ] Return top k similar events with similarity scores

### Task 4: iOS - AIBackendService Integration (AC1)
- [ ] Add `analyzeMessage()` method to `AIBackendService`
- [ ] Define request/response Codable structs
- [ ] Handle network errors gracefully
- [ ] Add timeout (10 seconds)

### Task 5: iOS - ChatViewModel Integration (AC2)
- [ ] After message sent, call `AIBackendService.analyzeMessage()`
- [ ] Store analysis result in state: `@Published var aiSuggestions: [String: AIAnalysis]`
- [ ] Don't block message sending (background task)
- [ ] Handle errors silently

### Task 6: iOS - AI Prompt UI (AC2)
- [ ] Create `AIPromptButton` SwiftUI component
- [ ] Display below message bubble
- [ ] Show only if analysis contains calendar event
- [ ] Styled with gentle color, icon
- [ ] Tappable action

### Task 7: iOS - Event Creation Modal (AC3)
- [ ] Create `EventCreationView` SwiftUI modal
- [ ] Pre-fill fields from AI analysis
- [ ] All fields editable
- [ ] Date/time pickers
- [ ] "Cancel" and "Create Event" buttons
- [ ] Validation: Title and Date required

### Task 8: iOS - EventService Updates (AC4, AC5, AC6)
- [ ] Add `createEvent()` method
- [ ] Save to Firestore `events` collection
- [ ] Call backend `/events/create` to generate embedding
- [ ] Handle deduplication response
- [ ] If "link existing", show confirmation modal
- [ ] Update local cache

### Task 9: iOS - Message Navigation (AC7)
- [ ] Add `scrollToMessageId` state to ChatView
- [ ] Implement scroll-to-message with ScrollViewReader
- [ ] Add highlight animation (yellow background, fade out)
- [ ] Test navigation from calendar → message

### Task 10: Manual Testing (AC1-8)
- [ ] Test: Send "Let's meet Friday at 3pm"
  - Verify AI prompt appears
  - Verify modal pre-filled correctly
  - Verify event saved to Firestore
- [ ] Test: Send similar event in another chat
  - Verify deduplication suggestion
- [ ] Test: Offline message sending
  - Verify no AI prompt (expected)
- [ ] Test: Navigate from calendar to message
  - Verify scroll and highlight work

---

## Technical Notes

### OpenAI Prompt Structure
```python
prompt = f"""
Analyze this message for calendar events:
"{message_text}"

Extract:
- title: brief event name
- date: ISO 8601 format
- time: HH:MM format or null
- location: place name or null

Return JSON:
{{
  "calendar": {{
    "detected": true/false,
    "title": "...",
    "date": "2025-10-27",
    "time": "15:00",
    "location": "Coffee Place"
  }}
}}
"""
```

### Event Schema (Firestore)
```typescript
interface Event {
  id: string
  title: string
  date: Timestamp
  time?: string  // "HH:MM"
  location?: string
  creatorUserId: string
  createdAt: Timestamp
  createdInConversationId: string
  createdAtMessageId: string
  invitations: Record<string, {
    messageId: string
    invitedUserIds: string[]
  }>
  attendees: Record<string, {
    status: "pending" | "accepted" | "declined"
    rsvpMessageId?: string
    rsvpConversationId?: string
    rsvpAt?: Timestamp
  }>
}
```

### Vector Metadata (Pinecone)
```json
{
  "id": "evt_123",
  "values": [0.123, ...],  // 1536-dim
  "metadata": {
    "event_id": "evt_123",
    "title": "Coffee meeting",
    "date": "2025-10-27",
    "user_id": "user_456",
    "type": "event"
  }
}
```

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Manual testing passed
- [ ] Events visible in calendar view
- [ ] AI prompts appear reliably
- [ ] Event deduplication working
- [ ] Message navigation working
- [ ] No crashes or errors
- [ ] Backend endpoints documented
- [ ] Code reviewed and follows standards

---

## Dependencies

**Upstream:** Story 5.0 (Python Backend Foundation)

**Downstream:** Story 5.4 (RSVP Tracking uses events)

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **Basic Event Detection**
   - Send: "Let's grab coffee tomorrow at 3pm"
   - Expected: AI prompt appears, modal shows "coffee" / tomorrow / 15:00

2. **Multiple Date Formats**
   - "Dinner Friday"
   - "Meeting on Oct 25"
   - "Party next Saturday at 8"
   - Expected: All correctly parsed

3. **Location Extraction**
   - "Meet at Starbucks downtown"
   - Expected: Location pre-filled

4. **No Event Detection**
   - "How are you?"
   - Expected: No AI prompt

5. **Event Deduplication**
   - Create "Birthday party Friday"
   - In another chat: "Birthday party Friday"
   - Expected: "Link to existing event?" prompt

6. **Message Navigation**
   - Create event from message
   - View in calendar
   - Tap "Jump to message"
   - Expected: Scroll to message, highlight

### Unit Testing (Optional)
Unit tests for OpenAI API integration and event parsing logic may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- Keep AI prompt subtle and non-intrusive
- Event creation should feel fast (<2 seconds total)
- Deduplication is basic for MVP (title + date similarity)
- Advanced features (recurring events, all-day) are out of scope

---

## References

- Technical Spec: Section "Smart Calendar Extraction"
- API Spec: `/analyze-message`, `/events/create`
- Firestore Schema: Events Collection

---

**Story 5.1 establishes the core pattern of AI-powered message analysis that all subsequent features will follow.**

