# Story 5.2: Decision Summarization with RAG

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 6  
**Priority:** High  
**Assigned To:** @dev  
**Status:** Not Started

---

## User Story

**As a** busy person making plans with friends,  
**I want** AI to detect and log decisions from our conversations,  
**so that** I can easily reference what we agreed to without scrolling through messages.

**And as a** user catching up on conversations,  
**I want** AI-powered summaries that understand the context from previous messages,  
**so that** I can quickly get up to speed without reading everything.

---

## Description

This story implements two related AI features:
1. **Decision Detection & Tracking:** AI detects when decisions are made ("Let's go to the Italian restaurant") and prompts the user to log them
2. **RAG-Enhanced Thread Summarization:** Uses vector search to find relevant historical context, then generates contextual summaries in three verbosity levels

Both features leverage LangChain's RAG (Retrieval-Augmented Generation) capabilities and Pinecone vector search.

---

## Acceptance Criteria

### AC1: Decision Detection
- [ ] AI analyzes outgoing messages for decision language
- [ ] Detects phrases: "let's do", "we'll go with", "okay, sounds good", "I'll", "we decided"
- [ ] Extracts decision text: "Going to Italian restaurant for dinner"
- [ ] "✓ Confirm decision?" button appears below message
- [ ] Button only shows if decision detected

### AC2: Decision Confirmation Modal
- [ ] Tapping button opens modal
- [ ] Modal shows AI-extracted decision text (editable)
- [ ] User can edit before confirming
- [ ] "Cancel" and "Confirm Decision" buttons
- [ ] Modal uses native iOS design

### AC3: Decision Storage
- [ ] Backend endpoint: `POST /api/v1/decisions`
- [ ] Generates embedding for decision text
- [ ] Stores in Pinecone namespace "decisions"
- [ ] Also stores in Firestore `decisions` collection
- [ ] Schema: id, userId, text, conversationId, sourceMessageId, timestamp
- [ ] Linked to source message for navigation

### AC4: Decisions View (Per-Chat)
- [ ] New tab in ChatView: [Messages] [Events & Reminders] [Decisions]
- [ ] Shows all decisions from this conversation
- [ ] Displays: Decision text, timestamp
- [ ] Tapping decision navigates to source message
- [ ] Real-time updates when new decisions added

### AC5: Global Decisions View
- [ ] New tab in Conversation List: [All] [Priority] [Decisions]
- [ ] Shows latest 10 decisions across all conversations
- [ ] Grouped by conversation
- [ ] Format: "Oct 23 | Dinner Plans | Going to Italian restaurant"
- [ ] Tapping navigates to conversation + message

### AC6: Semantic Decision Search
- [ ] Backend endpoint: `GET /api/v1/decisions/search?query=...`
- [ ] Uses Pinecone vector search
- [ ] User can search: "What did we decide about dinner?"
- [ ] Returns semantically similar decisions
- [ ] Works across all conversations
- [ ] Results sorted by similarity score

### AC7: RAG Thread Summarization
- [ ] Long-press conversation → "Summarize Unread" option
- [ ] Backend endpoint: `POST /api/v1/summarize-thread`
- [ ] Accept: conversationId, unread messages, verbosity
- [ ] Uses LangChain RetrievalQA chain
- [ ] Vector search Pinecone for relevant historical messages (k=5)
- [ ] Generates 3 summaries: brief, medium, detailed
- [ ] Returns all 3 simultaneously

### AC8: Summary Display
- [ ] Summary appears as center-aligned bubble in chat
- [ ] Gentle green background color
- [ ] No timestamp on summary
- [ ] Header: "From [Username]'s message at [time]" (link to first unread)
- [ ] Three tabs: [Brief] [Medium] [Detailed]
- [ ] Switch tabs instantly (no regeneration)
- [ ] [−] Minimize button

### AC9: Summary Persistence
- [ ] Summary stored locally (not in Firestore)
- [ ] Minimized/expanded state persists across app restarts
- [ ] Summary auto-deletes when new message sent or received
- [ ] Only one summary exists per conversation at a time

### AC10: Navigation from Summary
- [ ] Tapping "From [Username]..." link scrolls to first unread message
- [ ] Message briefly highlighted
- [ ] Smooth scroll animation

---

## Tasks

### Task 1: Backend - Decision Detection (AC1, AC3)
- [ ] Update `/analyze-message` to detect decisions
- [ ] Add decision detection to GPT-4o-mini prompt
- [ ] Return decision object: {detected: bool, text: string}
- [ ] Create `POST /decisions` endpoint
- [ ] Generate embedding for decision text
- [ ] Store in Pinecone namespace "decisions"
- [ ] Store in Firestore `decisions` collection

### Task 2: Backend - Decision Search (AC6)
- [ ] Create `GET /decisions/search` endpoint
- [ ] Accept: userId, query, conversationId (optional), k
- [ ] Use LangChain PineconeVectorStore.similarity_search()
- [ ] Filter by userId
- [ ] Optional filter by conversationId
- [ ] Return decisions with similarity scores

### Task 3: Backend - Decision Listing (AC5)
- [ ] Create `GET /decisions` endpoint
- [ ] Accept: userId, conversationId (optional), limit
- [ ] If conversationId: filter to that chat
- [ ] If no conversationId: return across all chats
- [ ] Sort by timestamp desc
- [ ] Return latest N decisions

### Task 4: Backend - RAG Summarization (AC7)
- [ ] Create `POST /summarize-thread` endpoint
- [ ] Accept: conversationId, unread_messages[], verbosity
- [ ] Combine unread message text
- [ ] Use LangChain vector store as retriever:
  ```python
  retriever = vector_store.as_retriever(
      search_kwargs={"k": 5, "filter": {"conversation_id": convId}}
  )
  ```
- [ ] Create RetrievalQA chain with custom prompt
- [ ] Prompt: Generate brief, medium, detailed summaries
- [ ] Use response_format="json_object"
- [ ] Return all 3 summaries + context message IDs

### Task 5: iOS - Decision Prompt UI (AC1, AC2)
- [ ] Update ChatView to show "✓ Confirm decision?" button
- [ ] Create `DecisionConfirmationView` modal
- [ ] Pre-fill with AI-extracted text
- [ ] Editable text field
- [ ] Cancel / Confirm buttons

### Task 6: iOS - DecisionService (AC3, AC6)
- [ ] Create `DecisionService.swift`
- [ ] Method: `createDecision(text, conversationId, messageId)`
- [ ] Calls backend `POST /decisions`
- [ ] Method: `listDecisions(conversationId?)`
- [ ] Calls backend `GET /decisions`
- [ ] Method: `searchDecisions(query, conversationId?)`
- [ ] Calls backend `GET /decisions/search`

### Task 7: iOS - Decisions View (Per-Chat) (AC4)
- [ ] Add [Decisions] tab to ChatView navigation
- [ ] Create `ChatDecisionsView` SwiftUI component
- [ ] List decisions for current conversation
- [ ] Display: Text, timestamp, tap to navigate
- [ ] Real-time updates via Firestore listener

### Task 8: iOS - Global Decisions View (AC5)
- [ ] Add [Decisions] tab to ConversationListView
- [ ] Create `GlobalDecisionsView` SwiftUI component
- [ ] Load latest 10 decisions across all conversations
- [ ] Group by conversation
- [ ] Format: Date | Conversation | Decision text
- [ ] Tapping navigates to conversation + message

### Task 9: iOS - RAG Summarization (AC7, AC8, AC9, AC10)
- [ ] Update long-press menu to include "Summarize Unread"
- [ ] Call `AIBackendService.summarizeThread()`
- [ ] Store summaries locally (UserDefaults or @AppStorage)
- [ ] Create `ThreadSummaryView` SwiftUI component
- [ ] Center-aligned bubble, green background
- [ ] Header with "From [user] at [time]" (tappable)
- [ ] Three tabs for verbosity levels
- [ ] Minimize button
- [ ] Store minimized/expanded state
- [ ] Delete summary on new message

### Task 10: Manual Testing (AC1-10)
- [ ] Test: Send "Okay, let's go with the Italian place"
  - Verify decision prompt appears
  - Confirm decision
  - Verify appears in Decisions view
- [ ] Test: Search "restaurant decisions"
  - Verify semantic search works
- [ ] Test: Long-press conversation with unread messages
  - Verify summary generated
  - Verify contextual (mentions previous messages)
  - Switch between brief/medium/detailed
  - Minimize and expand
- [ ] Test: Navigate from decision/summary to message
  - Verify scroll and highlight work

---

## Technical Notes

### Decision Detection Prompt
```python
prompt = f"""
Analyze if this message contains a decision:
"{message_text}"

Decision indicators:
- "let's", "we'll go with", "okay", "sounds good"
- "I'll", "we decided", "we're doing"

Return JSON:
{{
  "decision": {{
    "detected": true/false,
    "text": "brief statement of what was decided"
  }}
}}
"""
```

### RAG Chain Setup
```python
from langchain.chains import RetrievalQA
from langchain.prompts import PromptTemplate

template = """
Context from previous conversation:
{context}

Unread messages:
{question}

Generate 3 summaries (brief, medium, detailed) as JSON.
"""

prompt = PromptTemplate(template=template, input_variables=["context", "question"])

qa_chain = RetrievalQA.from_chain_type(
    llm=llm,
    chain_type="stuff",
    retriever=retriever,
    chain_type_kwargs={"prompt": prompt}
)
```

### Decision Schema (Firestore)
```typescript
interface Decision {
  id: string
  userId: string
  text: string
  conversationId: string
  sourceMessageId: string
  timestamp: Timestamp
}
```

### Summary Storage (iOS)
```swift
// UserDefaults or @AppStorage
struct ConversationSummary: Codable {
    let conversationId: String
    let brief: String
    let medium: String
    let detailed: String
    let sourceMessageId: String
    let isMinimized: Bool
    let timestamp: Date
}
```

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Decision detection working
- [ ] Decisions view implemented (per-chat + global)
- [ ] Semantic decision search working
- [ ] RAG summarization generating contextual summaries
- [ ] Summary UI with 3 verbosity levels
- [ ] Message navigation from decisions and summaries
- [ ] Manual testing passed
- [ ] Code reviewed

---

## Dependencies

**Upstream:** Story 5.0 (Backend Foundation)

**Downstream:** None

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **Decision Detection**
   - "Let's go with option A" → Decision detected
   - "What do you think?" → No decision
   - Confirm decision → Appears in Decisions view

2. **Semantic Search**
   - Log: "Going to Italian restaurant"
   - Search: "What did we decide about dinner?"
   - Expected: Finds the restaurant decision

3. **RAG Summarization**
   - Conversation with 10 messages, 5 unread
   - Long-press → Summarize Unread
   - Expected: Summary mentions context from old messages

4. **Summary Verbosity**
   - Switch between Brief/Medium/Detailed
   - Expected: Instant switch, no loading

5. **Summary Persistence**
   - Create summary, minimize
   - Close and reopen app
   - Expected: Still minimized
   - Send new message
   - Expected: Summary deleted

### Unit Testing (Optional)
Unit tests for RAG chain logic and decision parsing may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- RAG is the key differentiator - summaries should feel context-aware
- Decision tracking is unique - most apps don't do this
- Keep UI clean - decisions and summaries should enhance, not clutter
- Vector search makes semantic search feel "magical"

---

## References

- Technical Spec: Sections on "RAG Summarization" and "Decision Model"
- LangChain RAG Docs: https://python.langchain.com/docs/use_cases/question_answering/

---

**Story 5.2 showcases the power of RAG - contextual AI that actually understands conversation history.**

