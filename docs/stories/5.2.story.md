# Story 5.2: Decision Detection and Tracking

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 4  
**Priority:** High  
**Assigned To:** @dev  
**Status:** Not Started

---

## User Story

**As a** busy person making plans with friends,  
**I want** AI to detect and log decisions from our conversations using full conversation context,  
**so that** I can easily reference what we agreed to without scrolling through messages.

---

## Description

This story implements AI-powered decision detection and tracking. When users send messages that confirm decisions, the AI uses **lightweight RAG** (Retrieval-Augmented Generation) to:
1. Retrieve recent conversation context from Pinecone
2. Analyze the decision with full context (not just the current message)
3. Extract a complete, contextual decision summary

For example:
- Without context: "Yeah, sounds good" → Vague decision ❌
- With context: "Going to Italian restaurant on Main Street" → Complete decision ✅

The system stores decisions in both Firestore and Pinecone, enabling semantic search and navigation back to source messages.

---

## Acceptance Criteria

### AC1: Lightweight RAG for Context Retrieval
- [ ] When analyzing message for decisions, backend retrieves k=5 recent messages
- [ ] Uses Pinecone similarity search with conversation_id filter
- [ ] Messages include sender info and text content
- [ ] Retrieved context passed to GPT-4o-mini for analysis
- [ ] Fallback: If no context found, analyze current message only

### AC2: Context-Aware Decision Detection
- [ ] AI analyzes message WITH conversation context
- [ ] Detects decision phrases: "let's do", "we'll go with", "okay", "sounds good", "I'll", "we decided"
- [ ] Extracts COMPLETE decision text using context
- [ ] Example: "Yeah" + context("Italian restaurant on Main St") → "Going to Italian restaurant on Main Street"
- [ ] Returns structured JSON with decision text
- [ ] "✓ Confirm decision?" button appears below message

### AC3: Decision Confirmation Modal
- [ ] Tapping button opens modal
- [ ] Modal shows AI-extracted decision text (editable)
- [ ] User can edit before confirming
- [ ] "Cancel" and "Confirm Decision" buttons
- [ ] Modal uses native iOS design

### AC4: Decision Storage
- [ ] Backend endpoint: `POST /api/v1/decisions`
- [ ] Generates embedding for decision text
- [ ] Stores in Pinecone namespace "decisions"
- [ ] Also stores in Firestore `decisions` collection
- [ ] Schema: id, userId, text, conversationId, sourceMessageId, timestamp
- [ ] Linked to source message for navigation

### AC5: Decisions View (Per-Chat)
- [ ] New tab in ChatView: [Messages] [Events & Reminders] [Decisions]
- [ ] Shows all decisions from this conversation
- [ ] Displays: Decision text, timestamp
- [ ] Tapping decision navigates to source message
- [ ] Real-time updates when new decisions added

### AC6: Global Decisions View
- [ ] New tab in Conversation List: [All] [Priority] [Decisions]
- [ ] Shows latest 10 decisions across all conversations
- [ ] Grouped by conversation
- [ ] Format: "Oct 23 | Dinner Plans | Going to Italian restaurant"
- [ ] Tapping navigates to conversation + message

### AC7: Semantic Decision Search
- [ ] Backend endpoint: `GET /api/v1/decisions/search?query=...`
- [ ] Uses Pinecone vector search
- [ ] User can search: "What did we decide about dinner?"
- [ ] Returns semantically similar decisions
- [ ] Works across all conversations
- [ ] Results sorted by similarity score

---

## Tasks

### Task 1: Backend - Context Retrieval for Decisions (AC1, AC2)
- [ ] Update `/analyze-message` endpoint to implement lightweight RAG
- [ ] Step 1: Use `VectorStoreService.search_similar_messages()` to retrieve k=5 recent messages
- [ ] Filter by conversation_id
- [ ] Step 2: Build context string from retrieved messages
- [ ] Step 3: Create prompt with context + current message
- [ ] Step 4: Call GPT-4o-mini with contextual prompt
- [ ] Handle case where no context exists (fallback to current message only)
- [ ] Return decision object: {detected: bool, text: string}
- [ ] Generate embedding for message
- [ ] Store message in Pinecone namespace "messages"

### Task 2: Backend - Decision Storage (AC4)
- [ ] Create `POST /decisions` endpoint
- [ ] Accept: userId, text, conversationId, sourceMessageId
- [ ] Generate embedding for decision text
- [ ] Store in Pinecone namespace "decisions"
- [ ] Store in Firestore `decisions` collection
- [ ] Return decision ID and metadata

### Task 3: Backend - Decision Search (AC7)
- [ ] Create `GET /decisions/search` endpoint
- [ ] Accept: userId, query, conversationId (optional), k
- [ ] Use `VectorStoreService.search_similar_messages()` for decisions namespace
- [ ] Filter by userId
- [ ] Optional filter by conversationId
- [ ] Return decisions with similarity scores

### Task 4: Backend - Decision Listing (AC5, AC6)
- [ ] Create `GET /decisions` endpoint
- [ ] Accept: userId, conversationId (optional), limit
- [ ] If conversationId: filter to that chat
- [ ] If no conversationId: return across all chats
- [ ] Sort by timestamp desc
- [ ] Return latest N decisions

### Task 5: iOS - Decision Prompt UI (AC2, AC3)
- [ ] Update ChatView to show "✓ Confirm decision?" button
- [ ] Create `DecisionConfirmationView` modal
- [ ] Pre-fill with AI-extracted text
- [ ] Editable text field
- [ ] Cancel / Confirm buttons

### Task 6: iOS - DecisionService (AC4, AC7)
- [ ] Create `DecisionService.swift`
- [ ] Method: `createDecision(text, conversationId, messageId)`
- [ ] Calls backend `POST /decisions`
- [ ] Method: `listDecisions(conversationId?)`
- [ ] Calls backend `GET /decisions`
- [ ] Method: `searchDecisions(query, conversationId?)`
- [ ] Calls backend `GET /decisions/search`

### Task 7: iOS - Decisions View (Per-Chat) (AC5)
- [ ] Add [Decisions] tab to ChatView navigation
- [ ] Create `ChatDecisionsView` SwiftUI component
- [ ] List decisions for current conversation
- [ ] Display: Text, timestamp, tap to navigate
- [ ] Real-time updates via Firestore listener

### Task 8: iOS - Global Decisions View (AC6)
- [ ] Add [Decisions] tab to ConversationListView
- [ ] Create `GlobalDecisionsView` SwiftUI component
- [ ] Load latest 10 decisions across all conversations
- [ ] Group by conversation
- [ ] Format: Date | Conversation | Decision text
- [ ] Tapping navigates to conversation + message

### Task 9: Manual Testing (AC1-7)
- [ ] Test: Send message after discussing "Italian restaurant on Main Street"
  - Send: "Yeah, sounds good"
  - Verify decision prompt appears with FULL context
  - Expected: "Going to Italian restaurant on Main Street" (not just "sounds good")
- [ ] Test: Confirm decision
  - Verify appears in Decisions view with complete text
- [ ] Test: Search "restaurant decisions"
  - Verify semantic search works
- [ ] Test: Navigate from decision to message
  - Verify scroll and highlight work
- [ ] Test: No context scenario
  - Send: "Let's meet at 3pm Friday" (clear, self-contained decision)
  - Verify decision extracted correctly without needing context

---

## Technical Notes

### Lightweight RAG Implementation
```python
# In /analyze-message endpoint
from app.services.vector_store import get_vector_store
from app.services.openai_service import get_openai_service

def analyze_message_for_decisions(message_text, conversation_id, user_id):
    vector_store = get_vector_store()
    openai_service = get_openai_service()
    
    # Step 1: Retrieve recent context (lightweight RAG)
    recent_messages = vector_store.search_similar_messages(
        query=message_text,
        k=5,
        filter_dict={"conversation_id": conversation_id}
    )
    
    # Step 2: Build context string
    context = "\n".join([
        f"{msg['metadata'].get('sender', 'User')}: {msg['content']}"
        for msg in recent_messages
    ])
    
    # Step 3: Create contextual prompt
    prompt = f"""
Previous conversation:
{context}

Current message: "{message_text}"

Analyze if this message confirms or makes a decision. Use the previous conversation context to extract a COMPLETE decision statement.

Examples:
- "Yeah, sounds good" + context about Italian restaurant → "Going to Italian restaurant on Main Street"
- "Let's do 3pm" + context about meeting → "Meeting at 3pm on Friday"

Return JSON:
{{
  "decision": {{
    "detected": true/false,
    "text": "complete decision statement using context"
  }}
}}
"""
    
    # Step 4: Call GPT-4o-mini with context
    response = openai_service.chat_completion(
        messages=[{"role": "user", "content": prompt}],
        temperature=0.3
    )
    
    return parse_decision_response(response)
```

### Decision Detection Prompt
*(Included in Lightweight RAG Implementation above - no separate simple prompt needed)*

### Decision Schema (Firestore)
```typescript
interface Decision {
  id: string
  userId: string
  text: string
  conversationId: string
  sourceMessageId: string
  timestamp: Timestamp
}
```

---

## Definition of Done

- [ ] All acceptance criteria met (AC1-7)
- [ ] All tasks completed (Tasks 1-9)
- [ ] Lightweight RAG working for decision context retrieval
- [ ] Decision detection extracts complete, contextual summaries
- [ ] Decisions view implemented (per-chat + global)
- [ ] Semantic decision search working
- [ ] Message navigation from decisions working
- [ ] Manual testing passed
- [ ] Code reviewed and follows standards

---

## Dependencies

**Upstream:** Story 5.0 (Backend Foundation), Story 5.1 (Message analysis)

**Downstream:** None

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **Context-Aware Decision Detection**
   - Conversation: "Should we do Italian or Mexican?" → "What about that place on Main Street?"
   - Send: "Yeah, let's do that"
   - Expected: Decision detected as "Going to Italian restaurant on Main Street" (NOT just "let's do that")

2. **Self-Contained Decision**
   - Send: "Let's meet at Coffee Place Friday at 3pm"
   - Expected: Decision detected as "Meeting at Coffee Place Friday at 3pm" (works even without context)

3. **Semantic Search**
   - Log: "Going to Italian restaurant"
   - Search: "What did we decide about dinner?"
   - Expected: Finds the restaurant decision

4. **No Decision Detection**
   - Send: "How are you?"
   - Expected: No decision prompt appears

5. **Decision Persistence & Navigation**
   - Create decision from message
   - View in Decisions tab
   - Tap decision
   - Expected: Navigate to source message, highlight briefly

### Unit Testing (Optional)
Unit tests for lightweight RAG logic and decision parsing may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- **Lightweight RAG is the key differentiator** - decisions are contextually complete, not vague
- Decision tracking is unique - most apps don't do this
- Keep UI clean - decisions should enhance, not clutter
- Vector search makes semantic search feel "magical"
- The existing `VectorStoreService.search_similar_messages()` from 5.0 is perfect for this

---

## References

- Technical Spec: Section on "Decision Detection with Lightweight RAG"
- Story 5.0: VectorStoreService implementation
- LangChain Vector Search: https://python.langchain.com/docs/modules/data_connection/vectorstores/

---

**Story 5.2 showcases the power of lightweight RAG - contextual decision detection that actually understands conversation history.**
