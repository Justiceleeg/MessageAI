# Story 4.1: Improve Read Receipt UI Display

## Status

Draft

## Story

**As a** user,
**I want to** see an improved visual display for read receipts showing how many people have read my message,
**so that** I can quickly understand message delivery status at a glance in both 1:1 and group conversations.

## Acceptance Criteria

1. Delivered messages show a single gray checkmark (same as current).
2. Read messages show a blue circle with a white checkmark and a number indicating how many recipients have read the message.
3. The UI behavior is consistent for both 1:1 chats and group chats.
4. The loading/sending behavior remains unchanged (existing optimistic UI).
5. The delay between "delivered" and "read" status is reduced to under 1-2 seconds (currently experiencing longer delays).
6. Read receipt counts update in real-time as more recipients read the message.

## Tasks / Subtasks

- [ ] Task 1: Investigate and Fix Read Receipt Delay (AC: 5)
  - [ ] Review ChatViewModel.markMessagesAsDeliveredAsync() method
  - [ ] Review ChatViewModel.markMessageAsReadIfVisible() throttle delay
  - [ ] Identify cause of multi-second delay between delivered and read
  - [ ] Reduce throttle delay to 1-2 seconds maximum
  - [ ] Test that read receipts fire promptly after message delivery
  - [ ] Verify no performance degradation with faster updates

- [ ] Task 2: Create Read Receipt UI Component (AC: 2, 3)
  - [ ] Create new SwiftUI view component: ReadReceiptBadge
  - [ ] Implement blue circle with white checkmark icon
  - [ ] Add number overlay showing read count
  - [ ] Ensure component is reusable for both 1:1 and group chats
  - [ ] Add proper sizing and spacing for message bubbles
  - [ ] Follow iOS design guidelines for badge placement

- [ ] Task 3: Update MessageBubbleView with New Read Receipt Display (AC: 1, 2, 3)
  - [ ] Update MessageBubbleView to use ReadReceiptBadge component
  - [ ] Show single gray checkmark for status "delivered"
  - [ ] Show ReadReceiptBadge for status "read" with count
  - [ ] Calculate read count from message.readBy array
  - [ ] Ensure proper alignment with existing message layout
  - [ ] Test with various message lengths and group sizes
  - [ ] Verify behavior for sent/sending/failed states remains unchanged

- [ ] Task 4: Update ChatViewModel Read Receipt Logic (AC: 6)
  - [ ] Ensure computeMessageStatus() properly handles readBy counts
  - [ ] Verify real-time updates trigger UI refresh when readBy changes
  - [ ] Test that read count increments as participants read messages
  - [ ] Ensure conversation.participants list is properly loaded for count calculation
  - [ ] Add logging for read receipt count calculations

- [ ] Task 5: Testing (AC: All)
  - [ ] Unit test: ReadReceiptBadge component renders correctly
  - [ ] Unit test: Read count calculation logic
  - [ ] Manual test: Delivered status shows gray checkmark
  - [ ] Manual test: Read status shows blue badge with count
  - [ ] Manual test: Read count increments in real-time
  - [ ] Manual test: 1:1 chat read receipts display correctly
  - [ ] Manual test: Group chat read receipts display correctly
  - [ ] Manual test: Read receipt delay is under 1-2 seconds
  
  **Note:** This story will rely on manual testing for end-to-end validation. Integration tests are not required.

## Dev Notes

### Current Implementation Context

**Read Receipt System (Story 3.2):**
- Read receipts are tracked in Firestore via `readBy` array on message documents
- ChatViewModel handles marking messages as read via `markMessageAsReadIfVisible()`
- Current throttle delay: 2 seconds (line 1032 in ChatViewModel.swift)
- Status computation: `computeMessageStatus()` checks if all participants have read

**Existing Status Icons:**
- Currently uses text indicators or simple checkmarks
- Located in MessageBubbleView component
- Status types: "sending", "sent", "delivered", "read", "failed"

### Technical Requirements

**Component Architecture:**
[Source: docs/architecture/frontend-architecture.md#SwiftUI-Components]
- Create reusable SwiftUI components in Views/Shared/ directory
- Use @Published properties for real-time UI updates
- Follow existing MessageBubbleView pattern

**Data Models:**
[Source: docs/architecture/data-models.md#Message]
```swift
struct Message {
    let messageId: String
    let senderId: String
    let text: String
    let timestamp: Date
    var status: String  // "sending", "sent", "delivered", "read", "failed"
    var readBy: [String]  // Array of user IDs who have read the message
}
```

**Read Receipt Calculation:**
- For 1:1 chats: readBy.count should be 1 when read (other user)
- For group chats: readBy.count shows how many of N participants have read
- Exclude current user from participant count calculation

### File Locations

[Source: docs/architecture/unified-project-structure.md]
```
ios-app/MessageAI/
  ├── Views/
  │   ├── Chat/
  │   │   └── MessageBubbleView.swift (modify)
  │   └── Shared/
  │       └── ReadReceiptBadge.swift (create new)
  ├── ViewModels/
  │   └── ChatViewModel.swift (modify)
```

### Design Specifications

**Visual Requirements:**
- Delivered: Single gray checkmark ✓ (existing)
- Read: Blue circle background + white checkmark + number
- Colors: Use .blue for read status circle, .gray for delivered
- Badge size: ~20pt diameter circle
- Number: White text, centered on circle

**Behavior:**
- Show count even for 1:1 (will show "1")
- Update badge number in real-time as readBy array changes
- Maintain existing spacing and alignment in message bubbles

### Performance Considerations

**Read Receipt Delay Issue:**
- Current issue: Arbitrary delay of several seconds between delivered→read
- Root cause to investigate:
  - Throttle delay in markMessageAsReadIfVisible() (currently 2 seconds)
  - markMessagesAsDeliveredAsync() may have additional delays
  - Check for unnecessary Task.sleep() calls
- Target: Reduce total delay to under 1-2 seconds

**Real-time Updates:**
- ChatViewModel.messages is @Published
- Firestore listener updates trigger automatic UI refresh
- readBy array changes should immediately recalculate badge count

### Testing

[Source: docs/architecture/testing-strategy.md]
- Unit tests in MessageAITests/ directory for component and logic testing
- Use XCTest framework
- Mock Firestore data for read receipt scenarios
- **Manual Testing Focus:** This story will be validated primarily through manual testing
- Integration tests are not required - focus on unit tests for core logic and manual verification

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story draft for post-MVP read receipt UI improvements | Bob (SM) |

## Dev Agent Record

### Agent Model Used

*To be filled by Dev Agent*

### Debug Log References

*To be filled by Dev Agent*

### Completion Notes List

*To be filled by Dev Agent*

### File List

*To be filled by Dev Agent*

## QA Results

*To be filled by QA Agent*

