# Story 5.5: Deadline/Reminder Extraction

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 4  
**Priority:** High  
**Assigned To:** @dev  
**Status:** Not Started

---

## User Story

**As a** person making commitments in conversations,  
**I want** AI to detect my deadlines and help me set reminders,  
**so that** I don't forget what I promised to do.

---

## Description

AI detects when users make commitments or mention deadlines ("I'll send the docs by tomorrow", "Need to call John this afternoon") and prompts them to set reminders. Reminders are stored with embeddings in Pinecone for semantic search, persisted in Firestore, and trigger local iOS notifications at the due time.

---

## Acceptance Criteria

### AC1: Reminder Detection
- [ ] AI detects commitment language: "I'll", "I need to", "remind me to"
- [ ] Extracts task: "Send docs to John"
- [ ] Extracts due date/time: "tomorrow", "this afternoon", "by Friday EOD"
- [ ] Returns: {detected: bool, task: string, dueDate: ISO8601}
- [ ] "⏰ Set reminder?" button appears

### AC2: Reminder Confirmation Modal
- [ ] Tapping button opens modal
- [ ] Pre-filled task title (editable)
- [ ] Due date/time picker (default to extracted value)
- [ ] Reminder timing options:
  - ○ At due time (default)
  - ○ 1 hour before
  - ○ Morning of
- [ ] "Cancel" and "Set Reminder" buttons

### AC3: Reminder Storage
- [ ] Backend: `POST /api/v1/reminders`
- [ ] Generate embedding for task title
- [ ] Store in Pinecone namespace "reminders"
- [ ] Also store in Firestore `reminders` collection
- [ ] Schema: id, userId, title, dueDate, conversationId, sourceMessageId, completed
- [ ] Link to source message for navigation

### AC4: Notification Scheduling
- [ ] Use UNUserNotificationCenter
- [ ] Schedule notification at selected time
- [ ] Notification content: Reminder title
- [ ] Notification includes: reminderId, conversationId, messageId
- [ ] Tapping notification opens app → conversation → message

### AC5: Reminders View (Per-Chat)
- [ ] In ChatView: [Messages] [Events & Reminders] [Decisions] tab
- [ ] Shows all reminders for this conversation
- [ ] Display: Title, due date/time, completed status
- [ ] Swipe to mark complete
- [ ] Tapping reminder navigates to source message

### AC6: Global Reminders View
- [ ] In ConversationListView: Add to Calendar tab
- [ ] Calendar → [Events] [Reminders] sub-tabs
- [ ] Reminders tab shows all user's reminders
- [ ] Sorted by due date (ascending)
- [ ] Group by: TODAY, TOMORROW, THIS WEEK, LATER
- [ ] Shows conversation name per reminder
- [ ] Swipe to complete or delete

### AC7: Reminder Completion
- [ ] Mark reminder as complete
- [ ] Update Firestore: completed = true
- [ ] Cancel scheduled notification
- [ ] Move to "Completed" section (optional fold-out)
- [ ] Remains linked to message

### AC8: Semantic Reminder Search
- [ ] Backend: `GET /api/v1/reminders/search?query=...`
- [ ] Uses Pinecone vector search
- [ ] User searches: "What did I need to send?"
- [ ] Returns semantically similar reminders
- [ ] Works across all conversations

### AC9: Offline Behavior
- [ ] Reminders created online sync to Firestore
- [ ] Notification scheduling happens locally
- [ ] Notifications fire even if offline (iOS handles)
- [ ] If created offline: No vector embedding until online

---

## Tasks

### Task 1: Backend - Reminder Detection (AC1)
- [ ] Update `/analyze-message` to detect reminders
- [ ] Extract task and due date with GPT-4o-mini
- [ ] Parse natural date/time to ISO8601
- [ ] Return: {reminder: {task, dueDate}}

### Task 2: Backend - Reminder CRUD (AC3, AC8)
- [ ] Create `POST /reminders` endpoint
- [ ] Generate embedding for task title
- [ ] Store in Pinecone namespace "reminders"
- [ ] Store in Firestore `reminders` collection
- [ ] Create `GET /reminders` endpoint (list)
- [ ] Accept: userId, conversationId (optional), limit
- [ ] Create `GET /reminders/search` endpoint
- [ ] Vector search in Pinecone

### Task 3: Backend - Reminder Updates (AC7)
- [ ] Create `PATCH /reminders/{id}` endpoint
- [ ] Update completed status
- [ ] Update in Firestore and Pinecone metadata

### Task 4: iOS - Reminder Prompt UI (AC1, AC2)
- [ ] "⏰ Set reminder?" button below message
- [ ] Create `ReminderCreationModal` SwiftUI view
- [ ] Pre-fill task and due date
- [ ] Date/time pickers
- [ ] Reminder timing radio buttons
- [ ] Validation: Title and due date required

### Task 5: iOS - ReminderService (AC3, AC7, AC8)
- [ ] Create `ReminderService.swift`
- [ ] Method: `createReminder(title, dueDate, conversationId, messageId)`
- [ ] Calls backend `POST /reminders`
- [ ] Stores locally in SwiftData for offline access
- [ ] Method: `listReminders(conversationId?)`
- [ ] Method: `searchReminders(query)`
- [ ] Method: `completeReminder(id)`
- [ ] Update Firestore and cancel notification

### Task 6: iOS - Notification Scheduling (AC4)
- [ ] Update `NotificationManager` or create new `ReminderNotificationManager`
- [ ] Method: `scheduleReminder(reminder, timing)`
- [ ] Calculate notification trigger time
- [ ] Create UNNotificationRequest
- [ ] Store notificationId with reminder
- [ ] Handle notification tap → Navigate to conversation + message

### Task 7: iOS - Per-Chat Reminders View (AC5)
- [ ] Add "Events & Reminders" tab to ChatView
- [ ] Create `ChatRemindersView` SwiftUI component
- [ ] List reminders for current conversation
- [ ] Show: Title, due date, status
- [ ] Swipe actions: Complete, Delete
- [ ] Tapping reminder navigates to message

### Task 8: iOS - Global Reminders View (AC6)
- [ ] Update Calendar view structure
- [ ] Add [Events] [Reminders] sub-tabs
- [ ] Create `GlobalRemindersView` SwiftUI component
- [ ] Group reminders: TODAY, TOMORROW, THIS WEEK
- [ ] Show conversation name
- [ ] Swipe actions
- [ ] Tapping opens conversation + scrolls to message

### Task 9: iOS - Reminder Completion (AC7)
- [ ] Implement swipe-to-complete gesture
- [ ] Call `ReminderService.completeReminder()`
- [ ] Update Firestore
- [ ] Cancel notification with UNUserNotificationCenter
- [ ] Update UI (fade out or move to completed section)

### Task 10: Manual Testing (AC1-9)
- [ ] Test: Send "I'll send the docs by tomorrow"
  - Verify reminder button appears
  - Set reminder
  - Verify appears in Reminders view
  - Verify notification scheduled
- [ ] Test: Wait for notification (or manually trigger)
  - Verify notification appears
  - Tap notification
  - Verify navigates to message
- [ ] Test: Complete reminder
  - Swipe to complete
  - Verify notification cancelled
  - Verify marked complete
- [ ] Test: Search "What do I need to send?"
  - Verify finds "Send docs" reminder

---

## Technical Notes

### Reminder Detection Prompt
```python
prompt = f"""
Analyze if this message contains a commitment or deadline:
"{message_text}"

Commitment indicators:
- "I'll", "I need to", "remind me to"
- "by tomorrow", "this afternoon", deadlines

Extract:
- task: brief description
- dueDate: ISO8601 format

Return JSON:
{{
  "reminder": {{
    "detected": true/false,
    "task": "Send docs to John",
    "dueDate": "2025-10-24T17:00:00Z"
  }}
}}
"""
```

### Reminder Schema (Firestore)
```typescript
interface Reminder {
  id: string
  userId: string
  title: string
  dueDate: Timestamp
  conversationId: string
  sourceMessageId: string
  completed: boolean
  createdAt: Timestamp
  notificationId?: string
}
```

### Notification Scheduling
```swift
func scheduleReminder(_ reminder: Reminder, timing: ReminderTiming) async throws {
    let content = UNMutableNotificationContent()
    content.title = "Reminder"
    content.body = reminder.title
    content.sound = .default
    content.userInfo = [
        "reminderId": reminder.id,
        "conversationId": reminder.conversationId,
        "messageId": reminder.sourceMessageId,
        "type": "reminder"
    ]
    
    // Calculate trigger time based on timing option
    let triggerDate = calculateTriggerDate(dueDate: reminder.dueDate, timing: timing)
    
    let trigger = UNCalendarNotificationTrigger(
        dateMatching: Calendar.current.dateComponents(
            [.year, .month, .day, .hour, .minute],
            from: triggerDate
        ),
        repeats: false
    )
    
    let request = UNNotificationRequest(
        identifier: reminder.id,
        content: content,
        trigger: trigger
    )
    
    try await UNUserNotificationCenter.current().add(request)
}
```

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Reminder detection working
- [ ] Reminders stored with embeddings
- [ ] Notifications scheduled and firing
- [ ] Per-chat and global views implemented
- [ ] Reminder completion working
- [ ] Semantic search working
- [ ] Manual testing passed

---

## Dependencies

**Upstream:** Story 5.0 (Backend Foundation)

**Downstream:** None

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **Basic Reminder**
   - "I'll send the report by tomorrow 5pm"
   - Set reminder
   - Verify in Reminders view
   - Verify notification scheduled

2. **Notification Handling**
   - Wait for notification (or test with 1-minute delay)
   - Tap notification
   - Verify opens conversation + scrolls to message

3. **Reminder Completion**
   - Swipe to complete
   - Verify marked complete
   - Verify notification cancelled
   - Verify doesn't appear in active reminders

4. **Semantic Search**
   - Create reminder: "Buy birthday gift"
   - Search: "What do I need to get?"
   - Verify finds the reminder

5. **Multiple Reminders**
   - Create 5 reminders with different due dates
   - Verify sorted by date
   - Verify grouped correctly (TODAY, TOMORROW, etc.)

### Unit Testing (Optional)
Unit tests for reminder detection and date parsing logic may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- Reminders are personal (not shared with chat participants)
- Notification reliability is critical - use iOS best practices
- Consider timezone handling for due dates
- Keep UI clean - don't overwhelm with too many reminders

---

## References

- Technical Spec: Section "Deadline/Reminder Extraction"
- Apple Docs: UNUserNotificationCenter

---

**Story 5.5 turns conversational commitments into actionable reminders - practical AI that helps users keep their word.**

