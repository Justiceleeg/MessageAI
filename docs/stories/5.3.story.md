# Story 5.3: Priority Message Highlighting

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 2  
**Priority:** Medium  
**Assigned To:** @dev  
**Status:** Done

---

## User Story

**As a** busy person with multiple conversations,  
**I want** urgent or important messages to be visually highlighted,  
**so that** I can quickly see what needs my immediate attention.

---

## Description

AI automatically analyzes incoming messages for urgency indicators (keywords like "URGENT", deadlines, direct questions) and applies subtle color tints to conversations in the list view. This provides instant visual hierarchy without users needing to manually prioritize.

This is the simplest AI feature - pure classification with visual feedback.

---

## Acceptance Criteria

### AC1: Priority Analysis
- [x] AI analyzes incoming messages (not outgoing)
- [x] Detects urgency keywords: "URGENT", "ASAP", "emergency", "critical"
- [x] Detects deadlines: "by today", "need now", "immediately"
- [x] Detects direct questions: "Can you...?", "Will you...?"
- [x] Detects action requests: "Please respond", "Need your help"
- [x] Returns priority level: "low", "medium", or "high"

### AC2: Priority Classification
- [x] Medium (Yellow): Important but not urgent
  - "Important", "need", "can you"
  - Questions requiring response
  - FYI with action item
- [x] High (Red): Urgent/time-sensitive
  - "URGENT", "ASAP", "emergency"
  - Deadlines within hours
  - Blocking language: "waiting on you"

### AC3: Visual Indication (Conversation List)
- [x] Medium priority: Subtle yellow background tint (0.1 opacity)
- [x] High priority: Subtle red background tint (0.1 opacity)
- [x] Tint applied to entire conversation row
- [x] Tint persists until conversation read
- [x] Priority resets when all messages read

### AC4: Priority Stored in Firestore
- [x] Add `priority` field to Message document
- [x] Values: null, "medium", "high"
- [x] Conversation shows highest priority of unread messages
- [x] Real-time updates via Firestore listeners

### AC5: Optional Priority Notifications
- [x] User setting: "Priority Notifications" (on/off)
- [x] When ON:
  - Medium: Standard notification
  - High: Notification with timeSensitive interruption level (iOS 15+)
- [x] When OFF: All notifications standard
- [x] Setting stored in UserDefaults

### AC6: Performance
- [x] Priority analysis < 5 seconds (using GPT-4o-mini)
- [x] Doesn't block message delivery
- [x] Silent failure if backend unavailable
- [x] Works offline: No priority (defaults to normal)

---

## Tasks

### Task 1: Backend - Priority Detection (AC1, AC2)
- [x] Update `/analyze-message` to detect priority
- [x] GPT-4o-mini prompt for urgency classification
- [x] Return: {level: "low"|"medium"|"high", reason: string}
- [x] Test with various message types

### Task 2: Backend - Priority Logic (AC2)
- [x] Define urgency keywords list
- [x] Time-based urgency (deadline detection)
- [x] Language intensity analysis
- [x] Return structured priority object

### Task 3: iOS - Priority Analysis Integration (AC4)
- [x] When message received, analyze priority
- [x] Call `AIBackendService.analyzeMessage()`
- [x] Store priority in Message model
- [x] Update Firestore message document with priority field

### Task 4: iOS - Conversation Priority Calculation (AC3, AC4)
- [x] ConversationListViewModel calculates conversation priority
- [x] Logic: Highest priority of unread messages
- [x] If all read: No priority
- [x] Reactive to message updates

### Task 5: iOS - Visual Styling (AC3)
- [x] Update ConversationListView row styling
- [x] Add background color modifier:
  - medium: Color.yellow.opacity(0.1)
  - high: Color.red.opacity(0.1)
- [x] Test on light and dark mode
- [x] Ensure accessibility (sufficient contrast)

### Task 6: iOS - Settings UI (AC5)
- [x] Add "Priority Notifications" toggle to SettingsView
- [x] Store in UserDefaults
- [x] Default: OFF

### Task 7: iOS - Priority Notifications (AC5)
- [x] Update NotificationManager
- [x] Check "Priority Notifications" setting
- [x] If ON + high priority:
  - Use UNMutableNotificationContent.interruptionLevel = .critical
  - Or custom notification category
- [x] Test notification appearance

### Task 8: Manual Testing (AC1-6)
- [x] Test: Receive "URGENT: Need help now"
  - Verify red tint in conversation list
  - Verify priority notification (if enabled)
- [x] Test: Receive "Can you review this?"
  - Verify yellow tint
- [x] Test: Receive "Just checking in"
  - Verify no priority tint
- [x] Test: Mark all as read
  - Verify tint disappears
- [x] Test: Priority notifications on/off
  - Verify setting works

---

## Technical Notes

### Priority Detection Prompt
```python
prompt = f"""
Analyze urgency of this message:
"{message_text}"

Classify as:
- low: Normal conversation
- medium: Important, needs response
- high: Urgent, time-sensitive

Return JSON:
{{
  "priority": {{
    "level": "low|medium|high",
    "reason": "brief explanation"
  }}
}}
"""
```

### Message Schema Update
```swift
struct Message {
    // ...existing fields...
    var priority: Priority?  // NEW
}

enum Priority: String, Codable {
    case medium
    case high
}
```

### Conversation List Styling
```swift
HStack {
    // ...conversation content...
}
.listRowBackground(
    priorityColor(for: conversation)
)

func priorityColor(for conversation: Conversation) -> Color {
    guard let priority = conversation.highestUnreadPriority else {
        return Color.clear
    }
    switch priority {
    case .medium:
        return Color.yellow.opacity(0.1)
    case .high:
        return Color.red.opacity(0.1)
    }
}
```

---

## Definition of Done

- [x] All acceptance criteria met
- [x] All tasks completed
- [x] Priority detection working
- [x] Color tints displaying correctly
- [x] Priority notifications working (when enabled)
- [x] Manual testing passed
- [x] Accessible color contrast verified
- [x] Works in light and dark mode
- [x] Debug logs removed
- [x] Code cleaned up

---

## Dependencies

**Upstream:** Story 5.0 (Backend Foundation)

**Downstream:** None

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **High Priority**
   - Message: "URGENT: Server is down!"
   - Expected: Red tint, priority notification

2. **Medium Priority**
   - Message: "Can you review the proposal?"
   - Expected: Yellow tint

3. **No Priority**
   - Message: "Thanks!"
   - Expected: No tint

4. **Priority Reset**
   - High priority message
   - Open conversation, mark as read
   - Expected: Tint disappears

5. **Multiple Conversations**
   - 3 conversations: high, medium, normal
   - Expected: Correct colors on each

### Unit Testing (Optional)
Unit tests for priority classification logic may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- Keep visual treatment subtle - don't overwhelm users
- Priority should enhance, not distract
- Consider color-blind users (use icons if needed in future)
- This is simplest AI feature - good for quick win

---

## References

- Technical Spec: Section "Priority Message Highlighting"

---

**Story 5.3 provides immediate value with minimal complexity - the perfect "quick win" AI feature.**

---

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5

### Debug Log References
- None

### Completion Notes
- ✅ **STORY COMPLETE** - All acceptance criteria met and manually tested
- ✅ Backend: Enhanced `/analyze-message` endpoint with detailed priority detection logic
- ✅ Backend: Added `reason` field to priority detection response for transparency
- ✅ iOS: Added `Priority` enum (medium/high) to Message model
- ✅ iOS: Integrated AI priority analysis in ConversationListViewModel with real-time listeners
- ✅ iOS: Created `FirestoreService.fetchMessages()` for initial unread count calculation
- ✅ iOS: Applied visual styling with background colors (yellow/red 0.1 opacity)
- ✅ iOS: Added "Priority Notifications" toggle to SettingsView
- ✅ iOS: Updated NotificationManager with timeSensitive interruption level for high priority
- ✅ iOS: Fixed unread indicator by including `unreadCount` in `Conversation` equality check
- ✅ iOS: Optimized priority listeners to persist across navigation
- ✅ All debug logs and test code removed
- ✅ Build passes with no errors or warnings
- ✅ Feature works reliably across all tested scenarios

### File List
**Backend (Python):**
- `python-backend/app/services/openai_service.py` - Enhanced priority detection with detailed keywords and reason field
- `python-backend/app/models/responses.py` - Added reason field to PriorityDetection model

**iOS (Swift):**
- `ios-app/MessageAI/Models/Message.swift` - Added Priority enum and priority field
- `ios-app/MessageAI/Models/Conversation.swift` - Added unreadCount to equality check
- `ios-app/MessageAI/Services/AIBackendService.swift` - Added reason field to PriorityDetection struct
- `ios-app/MessageAI/Services/FirestoreService.swift` - Added fetchMessages() and updateMessagePriority() methods
- `ios-app/MessageAI/ViewModels/ConversationListViewModel.swift` - Added priority tracking with real-time listeners and unread count calculation
- `ios-app/MessageAI/ViewModels/ChatViewModel.swift` - Cleaned up (removed redundant Story 5.3 code)
- `ios-app/MessageAI/Views/Conversations/ConversationListView.swift` - Applied visual styling with background colors
- `ios-app/MessageAI/Views/Settings/SettingsView.swift` - Added Priority Notifications toggle
- `ios-app/MessageAI/Services/NotificationManager.swift` - Added priority notification handling

**Firebase:**
- `firebase/firestore.rules` - Added 'priority' to allowed update fields for messages

### Change Log
1. **Backend Enhancements:**
   - Enhanced GPT-4o-mini prompt with specific urgency keywords
   - Added reason field to explain priority classification

2. **iOS Data Models:**
   - Created Priority enum with medium/high cases
   - Extended Message model with optional priority field
   - Added unreadCount to Conversation model and equality check

3. **iOS Services:**
   - FirestoreService: Added fetchMessages() for one-time message fetch
   - FirestoreService: Added updateMessagePriority() to persist priority
   - AIBackendService: Updated PriorityDetection to include reason field
   - NotificationManager: Implemented timeSensitive interruption level for iOS 15+

4. **iOS ViewModels:**
   - ConversationListViewModel: Added priority listener system with real-time updates
   - ConversationListViewModel: Implemented calculateInitialUnreadCounts() for instant UI feedback
   - ConversationListViewModel: Added calculateHighestPriority() logic
   - ConversationListViewModel: Integrated AI analysis for unread messages
   - ChatViewModel: Cleaned up redundant Story 5.3 code (priority now handled in ConversationListViewModel)

5. **iOS Views:**
   - ConversationListView: Added listRowBackground() with priority colors (0.1 opacity)
   - ConversationListView: Priority listeners persist across navigation
   - ConversationListView: Added unread indicator (blue circle)
   - SettingsView: Added Priority Notifications toggle with UserDefaults

6. **Bug Fixes:**
   - Fixed unread indicator not showing by including unreadCount in Conversation equality
   - Fixed priority listeners restarting on navigation by removing stopPriorityListener from row onDisappear
   - Fixed SwiftUI not detecting changes by replacing array elements instead of mutating them

### Status
✅ **COMPLETE** - Ready for Production

