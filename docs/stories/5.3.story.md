# Story 5.3: Priority Message Highlighting

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 2  
**Priority:** Medium  
**Assigned To:** @dev  
**Status:** Not Started

---

## User Story

**As a** busy person with multiple conversations,  
**I want** urgent or important messages to be visually highlighted,  
**so that** I can quickly see what needs my immediate attention.

---

## Description

AI automatically analyzes incoming messages for urgency indicators (keywords like "URGENT", deadlines, direct questions) and applies subtle color tints to conversations in the list view. This provides instant visual hierarchy without users needing to manually prioritize.

This is the simplest AI feature - pure classification with visual feedback.

---

## Acceptance Criteria

### AC1: Priority Analysis
- [ ] AI analyzes incoming messages (not outgoing)
- [ ] Detects urgency keywords: "URGENT", "ASAP", "emergency", "critical"
- [ ] Detects deadlines: "by today", "need now", "immediately"
- [ ] Detects direct questions: "Can you...?", "Will you...?"
- [ ] Detects action requests: "Please respond", "Need your help"
- [ ] Returns priority level: "low", "medium", or "high"

### AC2: Priority Classification
- [ ] Medium (Yellow): Important but not urgent
  - "Important", "need", "can you"
  - Questions requiring response
  - FYI with action item
- [ ] High (Red): Urgent/time-sensitive
  - "URGENT", "ASAP", "emergency"
  - Deadlines within hours
  - Blocking language: "waiting on you"

### AC3: Visual Indication (Conversation List)
- [ ] Medium priority: Subtle yellow background tint
- [ ] High priority: Subtle red background tint
- [ ] Tint applied to entire conversation row
- [ ] Tint persists until conversation read
- [ ] Priority resets when all messages read

### AC4: Priority Stored in Firestore
- [ ] Add `priority` field to Message document
- [ ] Values: null, "medium", "high"
- [ ] Conversation shows highest priority of unread messages
- [ ] Real-time updates via Firestore listeners

### AC5: Optional Priority Notifications
- [ ] User setting: "Priority Notifications" (on/off)
- [ ] When ON:
  - Medium: Standard notification
  - High: Notification with red icon/background
- [ ] When OFF: All notifications standard
- [ ] Setting stored in UserDefaults

### AC6: Performance
- [ ] Priority analysis < 1 second
- [ ] Doesn't block message delivery
- [ ] Silent failure if backend unavailable
- [ ] Works offline: No priority (defaults to normal)

---

## Tasks

### Task 1: Backend - Priority Detection (AC1, AC2)
- [ ] Update `/analyze-message` to detect priority
- [ ] GPT-4o-mini prompt for urgency classification
- [ ] Return: {level: "low"|"medium"|"high", reason: string}
- [ ] Test with various message types

### Task 2: Backend - Priority Logic (AC2)
- [ ] Define urgency keywords list
- [ ] Time-based urgency (deadline detection)
- [ ] Language intensity analysis
- [ ] Return structured priority object

### Task 3: iOS - Priority Analysis Integration (AC4)
- [ ] When message received, analyze priority
- [ ] Call `AIBackendService.analyzeMessage()`
- [ ] Store priority in Message model
- [ ] Update Firestore message document with priority field

### Task 4: iOS - Conversation Priority Calculation (AC3, AC4)
- [ ] ConversationListViewModel calculates conversation priority
- [ ] Logic: Highest priority of unread messages
- [ ] If all read: No priority
- [ ] Reactive to message updates

### Task 5: iOS - Visual Styling (AC3)
- [ ] Update ConversationListView row styling
- [ ] Add background color modifier:
  - medium: Color.yellow.opacity(0.1)
  - high: Color.red.opacity(0.1)
- [ ] Test on light and dark mode
- [ ] Ensure accessibility (sufficient contrast)

### Task 6: iOS - Settings UI (AC5)
- [ ] Add "Priority Notifications" toggle to SettingsView
- [ ] Store in UserDefaults
- [ ] Default: OFF

### Task 7: iOS - Priority Notifications (AC5)
- [ ] Update NotificationManager
- [ ] Check "Priority Notifications" setting
- [ ] If ON + high priority:
  - Use UNMutableNotificationContent.interruptionLevel = .critical
  - Or custom notification category
- [ ] Test notification appearance

### Task 8: Manual Testing (AC1-6)
- [ ] Test: Receive "URGENT: Need help now"
  - Verify red tint in conversation list
  - Verify priority notification (if enabled)
- [ ] Test: Receive "Can you review this?"
  - Verify yellow tint
- [ ] Test: Receive "Just checking in"
  - Verify no priority tint
- [ ] Test: Mark all as read
  - Verify tint disappears
- [ ] Test: Priority notifications on/off
  - Verify setting works

---

## Technical Notes

### Priority Detection Prompt
```python
prompt = f"""
Analyze urgency of this message:
"{message_text}"

Classify as:
- low: Normal conversation
- medium: Important, needs response
- high: Urgent, time-sensitive

Return JSON:
{{
  "priority": {{
    "level": "low|medium|high",
    "reason": "brief explanation"
  }}
}}
"""
```

### Message Schema Update
```swift
struct Message {
    // ...existing fields...
    var priority: Priority?  // NEW
}

enum Priority: String, Codable {
    case medium
    case high
}
```

### Conversation List Styling
```swift
HStack {
    // ...conversation content...
}
.listRowBackground(
    priorityColor(for: conversation)
)

func priorityColor(for conversation: Conversation) -> Color {
    guard let priority = conversation.highestUnreadPriority else {
        return Color.clear
    }
    switch priority {
    case .medium:
        return Color.yellow.opacity(0.1)
    case .high:
        return Color.red.opacity(0.1)
    }
}
```

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Priority detection working
- [ ] Color tints displaying correctly
- [ ] Priority notifications working (when enabled)
- [ ] Manual testing passed
- [ ] Accessible color contrast verified
- [ ] Works in light and dark mode

---

## Dependencies

**Upstream:** Story 5.0 (Backend Foundation)

**Downstream:** None

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **High Priority**
   - Message: "URGENT: Server is down!"
   - Expected: Red tint, priority notification

2. **Medium Priority**
   - Message: "Can you review the proposal?"
   - Expected: Yellow tint

3. **No Priority**
   - Message: "Thanks!"
   - Expected: No tint

4. **Priority Reset**
   - High priority message
   - Open conversation, mark as read
   - Expected: Tint disappears

5. **Multiple Conversations**
   - 3 conversations: high, medium, normal
   - Expected: Correct colors on each

### Unit Testing (Optional)
Unit tests for priority classification logic may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- Keep visual treatment subtle - don't overwhelm users
- Priority should enhance, not distract
- Consider color-blind users (use icons if needed in future)
- This is simplest AI feature - good for quick win

---

## References

- Technical Spec: Section "Priority Message Highlighting"

---

**Story 5.3 provides immediate value with minimal complexity - the perfect "quick win" AI feature.**

