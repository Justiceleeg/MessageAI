# Story 5.4: RSVP Tracking

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 6  
**Priority:** High  
**Assigned To:** @dev  
**Status:** Ready for Review

---

## User Story

**As a** person coordinating social events,  
**I want** to create events with invitations and track RSVPs,  
**so that** I know who's attending without manually asking everyone.

---

## Description

AI detects when a user is creating an event invitation ("Party at my place Friday!") and automatically provides RSVP quick action buttons to recipients. This proactive approach eliminates the need for natural text responses and AI analysis. Users can:

1. Create events and invite chat participants
2. **RSVP with one tap** using quick action buttons (Accept/Decline)
3. Optionally add a message with their RSVP
4. Link the same event across multiple chats
5. Track attendee status in calendar view

**Key Innovation:** Recipients see RSVP buttons automatically when receiving an invitation - no need to type responses for AI to analyze. Natural language detection is optional fallback.

Builds on Story 5.1 (Smart Calendar Extraction) by adding the social coordination layer with optimized UX.

---

## Acceptance Criteria

### AC1: Invitation Detection
- [ ] AI detects invitation language: "party at my place", "come to", "join us for"
- [ ] Extracts event details: title, date, time, location
- [ ] Distinguishes from personal events (no invitation)
- [ ] Returns: {type: "create", eventTitle: "..."}
- [ ] "🎉 Create event and invite?" button appears

### AC2: Event Creation with Invitations
- [ ] Tapping button opens modal
- [ ] Pre-filled with event details
- [ ] "Invite all chat participants" option (default ON)
- [ ] Shows participant list
- [ ] "Create & Invite" button
- [ ] Event created in Firestore
- [ ] All participants added to attendees with status "pending"
- [ ] Event linked to this chat in invitations map

### AC3: RSVP Quick Actions (Proactive)
- [ ] When invitation message received (AC1 detected by sender)
- [ ] Invitation metadata passed to recipients via message
- [ ] Recipients automatically see RSVP quick action buttons on invitation message
- [ ] Buttons: "✓ Accept" and "✗ Decline"
- [ ] Buttons persist until user RSVPs
- [ ] Tapping button triggers RSVP confirmation modal (AC4)
- [ ] **Optional Fallback:** AI can detect natural RSVP language ("I'll be there") and show confirmation button

### AC4: RSVP Confirmation
- [ ] Tapping quick action button opens modal
- [ ] Shows: "RSVP for: [Event Title] on [Date]"
- [ ] Pre-selected option based on button tapped ("Accept" or "Decline")
- [ ] Optional: "Add a message" text field (e.g., "I'll bring wine!")
- [ ] "Confirm" button submits RSVP
- [ ] Updates Firestore event.attendees[userId].status
- [ ] Stores rsvpMessageId and rsvpConversationId
- [ ] If user added message, posts it to chat with RSVP confirmation badge

### AC5: Multi-Chat Event Linking
- [ ] User mentions same event in different chat
- [ ] AI searches Pinecone for similar events (same creator, same date, similar title)
- [ ] If similarity > 0.85: "Link to existing '[Event]' event?"
- [ ] If linked: Add new chat to event.invitations
- [ ] Add chat participants to event.attendees
- [ ] Single event ID across all chats

### AC6: Calendar View Integration
- [ ] Events with invitations show in calendar
- [ ] Event detail view shows:
  - Title, date, time, location
  - "Linked to Chats" section
  - List each chat with participant count
  - Tapping chat → Filtered attendee view → "Jump to Chat"
- [ ] Attendee status icons: ✓ (accepted), ⏳ (pending), ✗ (declined)

### AC7: Event Updates
- [ ] When RSVP submitted, all participants see update
- [ ] Real-time via Firestore listeners
- [ ] Calendar view shows current RSVP count
- [ ] Push notification to event creator: "[User] accepted your invitation"

### AC8: Navigation
- [ ] From calendar event → "Jump to Chat" for each linked chat
- [ ] Navigates to chat, scrolls to event creation/RSVP message
- [ ] Message briefly highlighted

---

## Tasks

### Task 1: Backend - Invitation Detection (AC1)
- [x] Update `/analyze-message` to detect invitations
- [x] RSVP intent classification: "create" (invitation sent)
- [x] Return: {type: "create", eventTitle, invitationDetected: true, eventId}
- [x] **Note:** Event ID must be returned so recipients can link to it

### Task 2: Backend - RSVP Detection (AC3 - Optional Fallback)
- [x] **OPTIONAL:** Detect RSVP language in message (fallback for natural responses)
- [x] Classify: "accepted" vs "declined"
- [x] Match to recent event (query Firestore for events in conversation)
- [x] Return: {type: "rsvp", eventId, status}
- [x] **Note:** This is fallback only; primary flow uses quick action buttons

### Task 3: Backend - Event Linking (AC5)
- [x] `/events/search` already exists (from 5.1)
- [x] When creating event, search for similar
- [x] Return suggestion if similarity > 0.85
- [x] `/events/link` endpoint to link event to new chat

### Task 4: iOS - Invitation UI (AC2)
- [x] "🎉 Create event and invite?" button
- [x] `EventInvitationModal` SwiftUI view
- [x] Pre-fill event details
- [x] Show participant list with checkboxes
- [x] "Invite all" toggle (default ON)
- [x] "Create & Invite" button

### Task 5: iOS - Event Creation with Invitations (AC2, AC5)
- [x] Update `EventService.createEvent()`
- [x] Add participants to event.attendees map
- [x] Store invitation details in event.invitations[chatId]
- [x] Call backend for event linking suggestion
- [x] If suggestion: Show "Link to existing?" modal

### Task 6: iOS - RSVP Quick Action Buttons (AC3, AC4)
- [x] Detect invitation messages via message.metadata.isInvitation
- [x] Display RSVP quick action buttons on invitation messages for recipients
- [x] Buttons: "✓ Accept" and "✗ Decline"
- [x] Buttons visible until user has RSVPed
- [x] Create `RSVPQuickActionsView` SwiftUI component
- [x] Tapping button opens `RSVPModal` (pre-selected with choice)
- [x] Modal shows event details and optional message field
- [x] "Confirm" submits RSVP via EventService

### Task 7: iOS - RSVP Submission (AC4, AC7)
- [x] Method: `EventService.rsvp(eventId, status, message?)`
- [x] Update Firestore event.attendees[userId]
- [x] Store rsvpMessageId, rsvpConversationId, rsvpAt
- [x] If user provided optional message, post to chat with RSVP badge
- [x] Trigger notification to event creator

### Task 8: iOS - Calendar Event Details (AC6)
- [x] Update EventDetailView
- [x] "Linked to Chats" section
- [x] List each chat with format: "[Chat Name] (5 invited)"
- [x] Tapping chat → Attendee drill-down view
- [x] Attendee view shows filtered list
- [x] "Jump to Chat" button navigates to conversation

### Task 9: iOS - Real-time Updates (AC7)
- [x] Firestore listener on events collection
- [x] Update calendar view when RSVPs change
- [x] Update attendee count in real-time
- [x] Show notification when RSVP received (if creator)

### Task 10: iOS - Message Metadata Handling (NEW)
- [x] When sending invitation message, store metadata on Message object
- [x] Message.metadata: { isInvitation: true, eventId: string }
- [x] Ensure metadata syncs to Firestore and all recipients
- [x] MessageBubbleView checks for metadata.isInvitation
- [x] If invitation and user hasn't RSVPed, show RSVPQuickActionsView

### Task 11: Manual Testing (AC1-8)
- [x] Test: Send "Party at my place Friday 8pm!"
  - Create event with invitations
  - Verify all chat participants invited
  - **NEW:** Verify recipients see quick action buttons automatically
- [x] Test: Recipient taps "Accept" button
  - **NEW:** Verify modal opens with "Accept" pre-selected
  - **NEW:** Optional: Add message "I'll bring wine!"
  - Confirm RSVP
  - Verify status updates in calendar
  - **NEW:** Verify optional message appears in chat with RSVP badge
- [x] Test: In another chat, mention same party
  - Verify "Link to existing?" suggestion
  - Link to same event
- [x] Test: View event in calendar
  - See multiple chats listed
  - Drill down to each chat's attendees
  - Navigate to chat from event
- [x] **Optional:** Test natural language fallback
  - Respond "I'll be there" without using button
  - Verify AI detection and RSVP button appears

---

## Technical Notes

### Architecture Pattern

Events follow the same storage pattern as Decisions (Story 5.2):
- **iOS EventService:** Handles Firestore CRUD operations (established in Story 5.1)
- **Backend:** Only handles Pinecone vector storage for semantic search
- **Endpoints:**
  - `POST /events/vector` - Store event embedding (from Story 5.1)
  - `GET /events/search` - Semantic event search (from Story 5.1)
  - `DELETE /events/vector/{id}` - Delete embedding

This story extends the Event model with invitation and RSVP tracking while maintaining the same storage architecture.

### RSVP Flow Architecture

**Proactive Button Approach (Primary):**
```
1. Sender types: "Party at my place Friday!"
2. AI detects invitation (AC1) → Returns eventId
3. Message stored with metadata: { isInvitation: true, eventId: "..." }
4. Recipients receive message
5. MessageBubbleView renders quick action buttons automatically
6. User taps button → Direct Firestore update (no AI call needed)
```

**Benefits:**
- ✅ Fewer AI calls (only detection, not response analysis)
- ✅ Instant UX (button tap = action)
- ✅ More predictable behavior
- ✅ Simpler testing

**Optional Fallback (Natural Language):**
```python
# Only if implementing fallback for users who type responses
prompt = f"""
Analyze if this message is an RSVP response:
"{message_text}"

RSVP indicators:
- "I'll be there", "count me in", "can't make it", "I'll pass"

Return JSON:
{{
  "rsvp": {{
    "type": "respond",
    "status": "accepted" | "declined" | null
  }}
}}
"""
```

### Event Schema (Firestore) - Extended from 5.1
```typescript
interface Event {
  // ...existing fields from 5.1...
  
  invitations: {
    [conversationId]: {
      messageId: string
      invitedUserIds: string[]
      timestamp: Timestamp
    }
  }
  
  attendees: {
    [userId]: {
      status: "pending" | "accepted" | "declined"
      rsvpMessageId?: string
      rsvpConversationId?: string
      rsvpAt?: Timestamp
    }
  }
}
```

### Message Schema (Firestore) - Extended
```typescript
interface Message {
  // ...existing fields...
  
  metadata?: {
    isInvitation?: boolean
    eventId?: string
    // Other metadata types from other stories...
  }
}
```

### Multi-Chat Event Linking
```swift
// Check for similar events before creating
let similar = try await eventService.searchSimilarEvents(title: title, date: date)

if let match = similar.first, match.similarity > 0.85 {
    // Show confirmation
    showLinkingAlert(existingEvent: match)
} else {
    // Create new event
    try await eventService.createEvent(...)
}
```

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Invitation detection working
- [ ] RSVP detection working
- [ ] Multi-chat event linking working
- [ ] Calendar shows attendee status
- [ ] Real-time updates working
- [ ] Navigation from calendar to messages
- [ ] Manual testing passed

---

## Dependencies

**Upstream:**
- Story 5.0 (Backend Foundation)
- Story 5.1 (Smart Calendar Extraction)

**Downstream:** None

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **Create Event with Invitations**
   - In group chat: "Party Friday at 8!"
   - Create event, invite all
   - Verify all marked as "pending"

2. **RSVP Acceptance**
   - User A creates event
   - User B responds: "I'll be there"
   - Verify RSVP detected
   - Verify status updates to "accepted"

3. **RSVP Decline**
   - Respond: "Sorry, can't make it"
   - Verify status "declined"

4. **Multi-Chat Linking**
   - Create event in Chat A
   - Mention in Chat B
   - Verify "Link existing?" prompt
   - Link successfully
   - Verify both chats in event.invitations

5. **Calendar View**
   - View event in calendar
   - See attendee count (5/8)
   - Drill down per chat
   - Navigate to each chat

### Unit Testing (Optional)
Unit tests for RSVP detection and event linking logic may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- **Architectural Optimization:** Proactive buttons reduce AI calls and improve UX
- Primary flow requires NO AI analysis of recipient responses
- Natural language fallback is optional (can be deferred)
- Multi-chat linking prevents event duplication
- Real-time updates create engaging experience
- Calendar becomes "social command center"
- Quick action buttons make RSVP friction-free (1 tap vs typing + AI analysis)

---

## References

- Technical Spec: Sections on "RSVP Tracking" and "Event Model"
- Story 5.1 for base event functionality

---

**Story 5.4 transforms calendar events from personal reminders into social coordination tools with optimized proactive UX.**

---

## Architectural Change Summary

**Original Design:** Reactive AI detection of RSVP responses  
**Updated Design:** Proactive quick action buttons with optional natural language fallback

**Impact:**
- ✅ **Reduces scope complexity** - Primary flow is UI-only (no AI analysis needed for RSVPs)
- ✅ **Improves UX** - One tap to RSVP vs typing and waiting for AI
- ✅ **Reduces costs** - Fewer OpenAI API calls per RSVP
- ✅ **Easier to test** - Button behavior is deterministic
- ✅ **Story points:** Remains at 6 (or could reduce to 5 if deferring natural language fallback)

**Key Addition:** Task 10 - Message metadata handling (lightweight, UI-focused)

## 🐛 Known Issues

### Event Deletion Bug
- **Issue:** Event deletion from calendar accessed via ChatView causes view reload/refresh instead of proper deletion
- **Status:** Bug confirmed - needs investigation
- **Workaround:** Use calendar from ConversationListView for event deletion
- **Priority:** Medium - affects user experience but has workaround
- **Next Steps:** 
  - Investigate navigation context differences between ChatView and ConversationListView calendar presentations
  - Check for state management issues in sheet presentation
  - Consider using consistent navigation patterns

