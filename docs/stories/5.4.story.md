# Story 5.4: RSVP Tracking

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 6  
**Priority:** High  
**Assigned To:** @dev  
**Status:** Not Started

---

## User Story

**As a** person coordinating social events,  
**I want** to create events with invitations and track RSVPs,  
**so that** I know who's attending without manually asking everyone.

---

## Description

AI detects when a user is creating an event invitation ("Party at my place Friday!") or responding to one ("Count me in!"). It handles:
1. Creating events and inviting chat participants
2. Detecting RSVP responses  
3. Multi-chat event linking (same event can be mentioned in multiple chats)
4. Calendar view showing attendee status

Builds on Story 5.1 (Smart Calendar Extraction) by adding the social coordination layer.

---

## Acceptance Criteria

### AC1: Invitation Detection
- [ ] AI detects invitation language: "party at my place", "come to", "join us for"
- [ ] Extracts event details: title, date, time, location
- [ ] Distinguishes from personal events (no invitation)
- [ ] Returns: {type: "create", eventTitle: "..."}
- [ ] "🎉 Create event and invite?" button appears

### AC2: Event Creation with Invitations
- [ ] Tapping button opens modal
- [ ] Pre-filled with event details
- [ ] "Invite all chat participants" option (default ON)
- [ ] Shows participant list
- [ ] "Create & Invite" button
- [ ] Event created in Firestore
- [ ] All participants added to attendees with status "pending"
- [ ] Event linked to this chat in invitations map

### AC3: RSVP Detection
- [ ] AI detects RSVP language: "I'll be there", "count me in", "I can make it", "Sorry, can't"
- [ ] Classifies response: "accepted" or "declined"
- [ ] Matches to recent event in conversation (last 10 messages)
- [ ] "✓ RSVP to [Event]?" button appears

### AC4: RSVP Confirmation
- [ ] Tapping button opens modal
- [ ] Shows: "RSVPing for: [Event Title] on [Date]"
- [ ] "Accept" or "Decline" options
- [ ] Links RSVP to message
- [ ] Updates Firestore event.attendees[userId].status
- [ ] Stores rsvpMessageId and rsvpConversationId

### AC5: Multi-Chat Event Linking
- [ ] User mentions same event in different chat
- [ ] AI searches Pinecone for similar events (same creator, same date, similar title)
- [ ] If similarity > 0.85: "Link to existing '[Event]' event?"
- [ ] If linked: Add new chat to event.invitations
- [ ] Add chat participants to event.attendees
- [ ] Single event ID across all chats

### AC6: Calendar View Integration
- [ ] Events with invitations show in calendar
- [ ] Event detail view shows:
  - Title, date, time, location
  - "Linked to Chats" section
  - List each chat with participant count
  - Tapping chat → Filtered attendee view → "Jump to Chat"
- [ ] Attendee status icons: ✓ (accepted), ⏳ (pending), ✗ (declined)

### AC7: Event Updates
- [ ] When RSVP submitted, all participants see update
- [ ] Real-time via Firestore listeners
- [ ] Calendar view shows current RSVP count
- [ ] Push notification to event creator: "[User] accepted your invitation"

### AC8: Navigation
- [ ] From calendar event → "Jump to Chat" for each linked chat
- [ ] Navigates to chat, scrolls to event creation/RSVP message
- [ ] Message briefly highlighted

---

## Tasks

### Task 1: Backend - Invitation Detection (AC1)
- [ ] Update `/analyze-message` to detect invitations
- [ ] RSVP intent classification: "create" or "respond"
- [ ] Return: {type, eventTitle, invitationDetected}

### Task 2: Backend - RSVP Detection (AC3)
- [ ] Detect RSVP language in message
- [ ] Classify: "accepted" vs "declined"
- [ ] Match to recent event (query Firestore for events in conversation)
- [ ] Return: {type: "rsvp", eventId, status}

### Task 3: Backend - Event Linking (AC5)
- [ ] `/events/search` already exists (from 5.1)
- [ ] When creating event, search for similar
- [ ] Return suggestion if similarity > 0.85
- [ ] `/events/link` endpoint to link event to new chat

### Task 4: iOS - Invitation UI (AC2)
- [ ] "🎉 Create event and invite?" button
- [ ] `EventInvitationModal` SwiftUI view
- [ ] Pre-fill event details
- [ ] Show participant list with checkboxes
- [ ] "Invite all" toggle (default ON)
- [ ] "Create & Invite" button

### Task 5: iOS - Event Creation with Invitations (AC2, AC5)
- [ ] Update `EventService.createEvent()`
- [ ] Add participants to event.attendees map
- [ ] Store invitation details in event.invitations[chatId]
- [ ] Call backend for event linking suggestion
- [ ] If suggestion: Show "Link to existing?" modal

### Task 6: iOS - RSVP UI (AC3, AC4)
- [ ] "✓ RSVP to [Event]?" button
- [ ] `RSVPModal` SwiftUI view
- [ ] Show event details
- [ ] "Accept" / "Decline" buttons
- [ ] Confirm and update Firestore

### Task 7: iOS - RSVP Submission (AC4, AC7)
- [ ] Method: `EventService.rsvp(eventId, status)`
- [ ] Update Firestore event.attendees[userId]
- [ ] Store rsvpMessageId, rsvpConversationId, rsvpAt
- [ ] Trigger notification to event creator

### Task 8: iOS - Calendar Event Details (AC6)
- [ ] Update EventDetailView
- [ ] "Linked to Chats" section
- [ ] List each chat with format: "[Chat Name] (5 invited)"
- [ ] Tapping chat → Attendee drill-down view
- [ ] Attendee view shows filtered list
- [ ] "Jump to Chat" button navigates to conversation

### Task 9: iOS - Real-time Updates (AC7)
- [ ] Firestore listener on events collection
- [ ] Update calendar view when RSVPs change
- [ ] Update attendee count in real-time
- [ ] Show notification when RSVP received (if creator)

### Task 10: Manual Testing (AC1-8)
- [ ] Test: Send "Party at my place Friday 8pm!"
  - Create event with invitations
  - Verify all chat participants invited
- [ ] Test: In another chat, mention same party
  - Verify "Link to existing?" suggestion
  - Link to same event
- [ ] Test: Receive invitation, respond "I'll be there"
  - Verify RSVP button appears
  - Confirm RSVP
  - Verify status updates in calendar
- [ ] Test: View event in calendar
  - See multiple chats listed
  - Drill down to each chat's attendees
  - Navigate to chat from event

---

## Technical Notes

### Invitation Detection Prompt
```python
prompt = f"""
Analyze if this message is an event invitation:
"{message_text}"

Invitation indicators:
- "party at", "join us", "come to", "you're invited"
- Includes date/time + activity

Return JSON:
{{
  "rsvp": {{
    "type": "create" | "respond" | null,
    "eventTitle": "...",
    "status": "accepted" | "declined" | null
  }}
}}
"""
```

### Event Schema (Firestore) - Extended from 5.1
```typescript
interface Event {
  // ...existing fields from 5.1...
  
  invitations: {
    [conversationId]: {
      messageId: string
      invitedUserIds: string[]
      timestamp: Timestamp
    }
  }
  
  attendees: {
    [userId]: {
      status: "pending" | "accepted" | "declined"
      rsvpMessageId?: string
      rsvpConversationId?: string
      rsvpAt?: Timestamp
    }
  }
}
```

### Multi-Chat Event Linking
```swift
// Check for similar events before creating
let similar = try await eventService.searchSimilarEvents(title: title, date: date)

if let match = similar.first, match.similarity > 0.85 {
    // Show confirmation
    showLinkingAlert(existingEvent: match)
} else {
    // Create new event
    try await eventService.createEvent(...)
}
```

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Invitation detection working
- [ ] RSVP detection working
- [ ] Multi-chat event linking working
- [ ] Calendar shows attendee status
- [ ] Real-time updates working
- [ ] Navigation from calendar to messages
- [ ] Manual testing passed

---

## Dependencies

**Upstream:**
- Story 5.0 (Backend Foundation)
- Story 5.1 (Smart Calendar Extraction)

**Downstream:** None

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **Create Event with Invitations**
   - In group chat: "Party Friday at 8!"
   - Create event, invite all
   - Verify all marked as "pending"

2. **RSVP Acceptance**
   - User A creates event
   - User B responds: "I'll be there"
   - Verify RSVP detected
   - Verify status updates to "accepted"

3. **RSVP Decline**
   - Respond: "Sorry, can't make it"
   - Verify status "declined"

4. **Multi-Chat Linking**
   - Create event in Chat A
   - Mention in Chat B
   - Verify "Link existing?" prompt
   - Link successfully
   - Verify both chats in event.invitations

5. **Calendar View**
   - View event in calendar
   - See attendee count (5/8)
   - Drill down per chat
   - Navigate to each chat

### Unit Testing (Optional)
Unit tests for RSVP detection and event linking logic may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- RSVP tracking is core social coordination feature
- Multi-chat linking prevents duplication
- Real-time updates create engaging experience
- Calendar becomes "social command center"

---

## References

- Technical Spec: Sections on "RSVP Tracking" and "Event Model"
- Story 5.1 for base event functionality

---

**Story 5.4 transforms calendar events from personal reminders into social coordination tools.**

