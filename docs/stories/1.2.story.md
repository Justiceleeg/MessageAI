# Story 1.2: Existing User Login & Logout

## Status

Done

## Story

**As an** existing user,
**I want** to log in and log out of my account,
**so that** I can access my messages securely.

## Acceptance Criteria

1. A user can access a login screen.
2. A user can log in using their existing Firebase Auth credentials.
3. Upon successful login, the user is navigated to the main app (e.g., Conversation List View).
4. If login fails (e.g., wrong password), a clear error message is displayed.
5. A logged-in user can find a "Logout" button (e.g., in the Settings View).
6. Tapping "Logout" signs the user out of Firebase Auth and navigates them back to the login screen.

## Tasks / Subtasks

- [x] Task 1: Extend AuthService with Login & Logout Methods (AC: 2, 6)
  - [x] Open existing `ios-app/MessageAI/Services/AuthService.swift`
  - [x] Implement `signIn(email: String, password: String)` method using Firebase Auth SDK's `Auth.auth().signIn(withEmail:password:)`
  - [x] Implement `signOut()` method using Firebase Auth SDK's `Auth.auth().signOut()`
  - [x] Update error handling to provide user-friendly error messages for login failures (wrong password, user not found, network errors)
  - [x] Add unit tests in `ios-app/MessageAITests/AuthServiceTests.swift` for signIn and signOut methods

- [x] Task 2: Create Login View UI (AC: 1, 2, 4)
  - [x] Create `ios-app/MessageAI/Views/Auth/LoginView.swift`
  - [x] Implement SwiftUI form with email TextField and password SecureField
  - [x] Add "Log In" Button (primary action)
  - [x] Add password show/hide toggle (eye icon inside password field, trailing position)
  - [x] Display error alerts for login failures (wrong credentials, network errors)
  - [x] Add navigation link or button to Sign-Up screen: "Don't have an account? Sign Up"
  - [x] Use native SwiftUI components for consistent iOS look and feel
  - [x] Follow UI specifications from `docs/front-end-spec.md` (similar to Sign-Up screen but without Display Name field)
  - [x] Implement accessibility requirements (VoiceOver labels, Dynamic Type support, 44pt touch targets)
  - [x] Add SwiftUI Preview for UI testing

- [x] Task 3: Update AuthViewModel for Login Flow (AC: 2, 3, 4)
  - [x] Open existing `ios-app/MessageAI/ViewModels/AuthViewModel.swift`
  - [x] Implement `signIn(email: String, password: String)` method that:
    - Calls AuthService.signIn()
    - On success, AuthService.currentUser is automatically updated by Firebase Auth state listener
    - On failure, updates @Published error state for UI error display
  - [x] Implement `signOut()` method that:
    - Calls AuthService.signOut()
    - Clears currentUser state
    - Triggers navigation back to login screen
  - [x] Add @Published properties for loading state and error messages (reuse existing if present)
  - [x] Add unit tests in `ios-app/MessageAITests/AuthViewModelTests.swift` for signIn and signOut methods

- [x] Task 4: Update App Navigation for Login Flow (AC: 1, 3, 6)
  - [x] Update `ios-app/MessageAI/MessageAIApp.swift` root view to show LoginView as default auth screen (instead of SignUpView)
  - [x] Ensure LoginView is shown when user is not authenticated
  - [x] Ensure navigation to Conversation List View happens automatically when AuthService.currentUser is not nil
  - [x] Add navigation from LoginView to SignUpView and vice versa
  - [x] Test bidirectional navigation between Login and Sign-Up screens

- [x] Task 5: Create Settings View with Logout Button (AC: 5, 6)
  - [x] Create `ios-app/MessageAI/Views/Settings/SettingsView.swift`
  - [x] Implement basic settings screen layout with List view
  - [x] Add "Logout" button in settings (red/destructive style)
  - [x] Wire logout button to AuthViewModel.signOut()
  - [x] Display confirmation alert before logout (optional but recommended)
  - [x] Add navigation to Settings View from Conversation List View (e.g., gear icon in navigation bar)
  - [x] Use native SwiftUI components (List, Button, NavigationLink)
  - [x] Add SwiftUI Preview for UI testing

- [x] Task 6: Update Conversation List View Navigation (AC: 5)
  - [x] Open existing `ios-app/MessageAI/Views/Conversations/ConversationListView.swift`
  - [x] Remove or update existing placeholder "Sign Out" button if present
  - [x] Add navigation bar button (trailing position) to access Settings View
  - [x] Use SF Symbol `gear` or `gearshape.fill` for settings icon
  - [x] Ensure navigation works correctly with NavigationStack

- [x] Task 7: Integration Testing (AC: 1, 2, 3, 4, 5, 6)
  - [x] Update integration tests in `ios-app/MessageAITests/SignUpFlowTests.swift` or create new test file for login
  - [x] Test complete login flow: UI → ViewModel → AuthService → Firebase Auth
  - [x] Test login with valid credentials (use test account from Story 1.1)
  - [x] Test login with invalid credentials (wrong password, non-existent user)
  - [x] Test navigation to main app on successful login
  - [x] Test logout flow: Settings button tap → Logout → Navigate to login screen
  - [x] Test error scenarios (network errors, invalid email format)
  - [x] Verify AuthService.currentUser state changes correctly during login/logout

## Dev Notes

### Previous Story Insights

**From Story 1.1:**
- Firebase SDK already integrated (Auth, Firestore, FirestoreSwift)
- AuthService exists as ObservableObject with @Published currentUser property and signUp() method
- FirestoreService exists for user profile operations (no changes needed for this story)
- AuthViewModel coordinates auth flows between services
- Auth-based navigation routing working in MessageAIApp.swift
- SwiftData persistence layer configured
- User models exist (User and UserEntity)
- Testing infrastructure established with XCTest

**Key Technical Foundation Built:**
✓ Firebase Auth SDK integrated  
✓ AuthService with state management  
✓ Navigation Stack with auth-based conditional rendering  
✓ Error handling patterns established  
✓ Testing patterns established  

**This Story Extends:**
- AuthService: Add `signIn()` and `signOut()` methods
- AuthViewModel: Add corresponding ViewModel methods
- Navigation: Switch default to LoginView, add Settings navigation
- UI: Create LoginView and SettingsView

### UI/UX Specification

**IMPORTANT**: Complete UI/UX design specification available at: `docs/front-end-spec.md`

**Applies to Login Screen (with modifications from Sign-Up):**
- Follow same design patterns, spacing, typography, color palette from Sign-Up screen
- Login screen differences from Sign-Up:
  - NO Display Name field (only Email + Password)
  - Footer link: "Don't have an account? Sign Up" (instead of "Already have an account? Sign In")
  - Title: "Welcome Back" or "Log In" (instead of "Create your account")
- Reuse components: ValidatedTextField, PrimaryButton, ErrorMessage, PasswordToggle
- All accessibility requirements apply (VoiceOver, Dynamic Type, Reduce Motion, 44pt touch targets)
- All animation specifications apply (same durations, easing curves)
- All spacing follows 8pt grid system
- All colors use system semantic colors (adapts to Light/Dark mode)

**Settings Screen Design:**
- Simple List-based layout (native iOS Settings style)
- Section for "Account" with "Logout" row
- Logout row: Red text (destructive style), SF Symbol `arrow.right.square` (optional)
- Navigation bar title: "Settings"
- Future sections can be added (Theme selection in Story 1.3)

**Key UI Decisions:**
- Login screen follows same minimal, native iOS aesthetic as Sign-Up
- Settings screen uses standard iOS List component (familiar pattern)
- Logout action is clear and easily discoverable in Settings

### Architecture Context

**Tech Stack** [Source: architecture/tech-stack.md]
- Frontend: Swift 5.9+, SwiftUI (Latest), Native SwiftUI Components
- State Management: SwiftUI built-in (@State, @StateObject, @ObservedObject, @EnvironmentObject)
- Authentication: Firebase Auth (Cloud)
- Database: Firebase Firestore (Remote), SwiftData (iOS 17+ for local cache)
- Testing: XCTest for unit/UI testing

**Project Structure** [Source: architecture/unified-project-structure.md]
```
ios-app/
├── MessageAI/
│   ├── Models/          # User, UserEntity (existing)
│   ├── Views/           # SwiftUI Views
│   │   ├── Auth/        # LoginView.swift (NEW), SignUpView.swift (existing)
│   │   ├── Settings/    # SettingsView.swift (NEW)
│   │   ├── Conversations/ # ConversationListView.swift (UPDATE)
│   │   └── Shared/
│   ├── ViewModels/      # AuthViewModel.swift (UPDATE)
│   ├── Services/        # AuthService.swift (UPDATE)
│   └── Persistence/     # PersistenceController.swift (existing, no changes)
├── MessageAI.xcodeproj
└── MessageAITests/      # AuthServiceTests.swift, AuthViewModelTests.swift (UPDATE)
```

**Data Models** [Source: architecture/data-models.md]
- No new data models needed
- Existing User model and UserEntity remain unchanged
- AuthService.currentUser is the source of truth for auth state

**Authentication Flow** [Source: architecture/authentication-and-authorization.md#Auth-Flow]

**Login Flow:**
1. User enters credentials (email + password), taps Log In
2. App calls AuthViewModel.signIn()
3. AuthViewModel calls AuthService.signIn()
4. AuthService calls Firebase Auth SDK `Auth.auth().signIn(withEmail:password:)`
5. Firebase Auth verifies credentials
6. On success: Firebase Auth updates currentUser, app automatically navigates to main app
7. On failure: AuthService returns error, App displays error message to user

**Logout Flow:**
1. User navigates to Settings, taps Logout
2. App calls AuthViewModel.signOut()
3. AuthViewModel calls AuthService.signOut()
4. AuthService calls Firebase Auth SDK `Auth.auth().signOut()`
5. AuthService clears currentUser state
6. App automatically navigates back to LoginView (auth state change)

**Component Architecture** [Source: architecture/frontend-architecture.md#Component-Architecture]
- Pattern: MVVM (Model-View-ViewModel)
- Views: SwiftUI views in `Views/` directory, organized by feature
- ViewModels: ObservableObjects with @Published properties
- Services: Firebase SDK wrappers (AuthService)
- Dependency Injection: Services injected into ViewModels

**AuthService Extension Template:**
```swift
import FirebaseAuth

class AuthService: ObservableObject {
    @Published var currentUser: User?
    
    func signUp(email: String, password: String) async throws -> User {
        // Existing implementation from Story 1.1
    }
    
    func signIn(email: String, password: String) async throws {
        let authResult = try await Auth.auth().signIn(withEmail: email, password: password)
        // Update currentUser based on authResult
    }
    
    func signOut() throws {
        try Auth.auth().signOut()
        currentUser = nil
    }
}
```

**State Management** [Source: architecture/frontend-architecture.md#State-Management-Architecture]
- Use SwiftUI built-in property wrappers (@State, @StateObject, @ObservedObject, @EnvironmentObject)
- ViewModels expose state via @Published properties
- AuthService.currentUser state drives navigation (authenticated vs unauthenticated views)

**Routing** [Source: architecture/frontend-architecture.md#Routing-Architecture]
- Use NavigationStack (iOS 16+)
- Root view checks AuthService.currentUser to show Login/SignUp or Main App
- Protected Route Pattern: Conditionally render based on AuthService.currentUser state
- Navigation from Login ↔ Sign-Up via NavigationLink
- Navigation to Settings via NavigationLink from Conversation List

**Error Handling** [Source: architecture/error-handling-strategy.md#Frontend-Error-Handling]
- Use do-catch or Result for service calls
- ViewModels catch errors, log using OSLog
- Update @Published error state for UI display
- Display user-friendly error messages via Alert or inline text

**Common Login Error Messages:**
- Wrong password: "Incorrect password. Please try again."
- User not found: "No account found with this email. Sign up instead?"
- Invalid email: "Please enter a valid email address"
- Network error: "Connection failed. Please check your internet and try again."
- Too many requests: "Too many login attempts. Please try again later."

**Coding Standards** [Source: architecture/coding-standards.md]
- Files: PascalCase (e.g., `LoginView.swift`, `SettingsView.swift`)
- Classes/Structs: PascalCase (e.g., `AuthViewModel`)
- Functions/Methods: camelCase (e.g., `signIn()`, `signOut()`)
- Variables: camelCase (e.g., `currentUser`)
- Use official Firebase SDKs
- Consistent error handling: Swift do-catch/Result patterns
- Rely on Firestore Security Rules

**Firebase SDK Methods:**
- Login: `Auth.auth().signIn(withEmail: email, password: password)` - returns AuthDataResult
- Logout: `Auth.auth().signOut()` - void method, throws error if fails
- Current user listener: Firebase Auth automatically updates state via delegate pattern

### Testing

**Testing Standards** [Source: architecture/testing-strategy.md]

**Test Organization:**
- Unit tests location: `ios-app/MessageAITests/`
- UI tests location: `ios-app/MessageAIUITests/`

**Frontend Testing:**
- Framework: XCTest (Native iOS testing framework)
- Unit tests for ViewModels: Mock services, test business logic
- Unit tests for Services: Mock Firebase SDK calls where possible
- UI tests: XCUITest for end-to-end user flows
- Test naming convention: `test{MethodName}_{Scenario}_{ExpectedResult}`

**Testing Requirements for This Story:**

1. **AuthService unit tests:**
   - Test successful sign-in with valid credentials
   - Test sign-in with invalid email (user not found)
   - Test sign-in with wrong password
   - Test sign-in network error handling
   - Test successful sign-out
   - Test sign-out error handling

2. **AuthViewModel unit tests:**
   - Test sign-in flow coordination with mocked AuthService
   - Test sign-out flow coordination with mocked AuthService
   - Test error state updates during sign-in failures
   - Test loading state during sign-in operation
   - Mock AuthService to isolate ViewModel logic

3. **Integration tests:**
   - Test complete login flow from UI to Firebase (using test account)
   - Test navigation to main app on successful login
   - Test error message display on login failure
   - Test complete logout flow from Settings
   - Test navigation back to login screen after logout
   - Test switching between Login and Sign-Up screens

4. **UI tests (optional for MVP, recommended):**
   - Test login screen displays correctly
   - Test form validation (email format)
   - Test error message display
   - Test navigation to Settings
   - Test logout button functionality

**Test Example:**
```swift
// Example unit test structure
import XCTest
@testable import MessageAI

final class AuthServiceTests: XCTestCase {
    var authService: AuthService!
    
    override func setUp() {
        super.setUp()
        authService = AuthService()
    }
    
    func testSignIn_WithValidCredentials_ReturnsSuccess() async throws {
        // Arrange
        let email = "test@example.com"
        let password = "TestPass123"
        
        // Act
        try await authService.signIn(email: email, password: password)
        
        // Assert
        XCTAssertNotNil(authService.currentUser)
        XCTAssertEqual(authService.currentUser?.email, email)
    }
    
    func testSignOut_WhenCalled_ClearsCurrentUser() throws {
        // Arrange
        authService.currentUser = User(userId: "test123", displayName: "Test", presence: "online", lastSeen: Date())
        
        // Act
        try authService.signOut()
        
        // Assert
        XCTAssertNil(authService.currentUser)
    }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

No debug issues encountered during implementation.

### Completion Notes List

- All 7 tasks completed successfully
- Tasks 1, 3 were already complete from Story 1.1 (AuthService and AuthViewModel had signIn/signOut methods)
- Created LoginView following same UI patterns as SignUpView
- Created SettingsView with logout functionality and confirmation dialog
- Updated app navigation to show LoginView as default (instead of SignUpView)
- Added bidirectional navigation between Login and Sign-Up screens
- Added Settings navigation to Conversation List (gear icon in toolbar)
- Created comprehensive integration tests for login/logout flows
- **Bug Fix**: Fixed failing test in AuthViewModelTests line 85 - Added `isAuthenticated = false` in error handlers for both signIn() and signUp() methods to ensure authentication state is properly cleared on failure
- All acceptance criteria met:
  - AC1: Login screen accessible ✅
  - AC2: User can log in with Firebase Auth credentials ✅
  - AC3: Navigation to main app on successful login ✅
  - AC4: Clear error messages on login failure ✅
  - AC5: Logout button accessible in Settings View ✅
  - AC6: Logout signs out and navigates to login screen ✅

### File List

**Created:**
- `ios-app/MessageAI/Views/Auth/LoginView.swift` - Login UI with email/password fields, validation, navigation to sign-up
- `ios-app/MessageAI/Views/Settings/SettingsView.swift` - Settings screen with logout button and confirmation dialog
- `ios-app/MessageAITests/LoginFlowTests.swift` - Integration tests for login/logout flows

**Modified:**
- `ios-app/MessageAI/MessageAIApp.swift` - Changed default auth screen from SignUpView to LoginView
- `ios-app/MessageAI/Views/Auth/SignUpView.swift` - Added navigation link back to LoginView
- `ios-app/MessageAI/Views/Conversations/ConversationListView.swift` - Removed center sign-out button, added settings gear icon to toolbar
- `ios-app/MessageAI/ViewModels/AuthViewModel.swift` - Fixed bug: Added `isAuthenticated = false` in error handlers for signIn() and signUp() methods to ensure authentication state is cleared on failure

**Existing (No Changes Required):**
- `ios-app/MessageAI/Services/AuthService.swift` - Already had signIn() and signOut() methods from Story 1.1
- `ios-app/MessageAITests/AuthServiceTests.swift` - Already had tests for signIn/signOut from Story 1.1
- `ios-app/MessageAITests/AuthViewModelTests.swift` - Already had tests for signIn/signOut from Story 1.1

## QA Results

_To be populated by QA Agent_

