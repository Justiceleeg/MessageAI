# Story 3.6: Enable Background Notifications

## Status

Draft

## Story

**As a** user,
**I want** to receive notifications for new messages even when the app is completely backgrounded,
**so that** I never miss important communications regardless of app state.

## Acceptance Criteria

1. When the app is backgrounded and a new message arrives, a notification appears on the device lock screen
2. Background App Refresh capability is enabled in the app settings
3. Firestore listeners continue working for up to 30 seconds after app backgrounding
4. Background processing tasks handle notification delivery when app is suspended
5. Notifications work reliably when app is completely closed (not just backgrounded)
6. Background processing gracefully handles iOS execution time limits
7. No impact on battery life or app performance when foregrounded

## Tasks / Subtasks

- [ ] Task 1: Enable Background App Refresh Capability (AC: 2)
  - [ ] Add "Background App Refresh" capability to Xcode project settings
  - [ ] Configure background modes: "Background processing" and "Background fetch"
  - [ ] Update Info.plist with required background modes
  - [ ] Test capability appears in iOS Settings > MessageAI > Background App Refresh

- [ ] Task 2: Implement Background Task Handling (AC: 3, 4, 6)
  - [ ] Create BackgroundTaskManager service to handle iOS background execution
  - [ ] Implement background task registration in NotificationManager
  - [ ] Add background task completion handling for iOS time limits
  - [ ] Integrate with existing Firestore listeners to extend their lifetime
  - [ ] Add comprehensive logging for background task lifecycle

- [ ] Task 3: Extend NotificationManager for Background Processing (AC: 1, 5)
  - [ ] Modify NotificationManager to register background tasks when app backgrounds
  - [ ] Ensure Firestore listeners remain active during background execution
  - [ ] Handle notification delivery when app is completely closed
  - [ ] Add fallback mechanism for when background execution expires
  - [ ] Integrate with existing AI reminder notification system (Story 5.5)
  - [ ] Test notification delivery in all app states (foreground, background, closed)

- [ ] Task 4: Optimize Background Performance (AC: 7)
  - [ ] Implement efficient background task scheduling
  - [ ] Add background task monitoring and cleanup
  - [ ] Ensure minimal CPU usage during background execution
  - [ ] Add battery usage monitoring and optimization
  - [ ] Test battery impact over extended background periods

- [ ] Task 5: Testing and Validation (AC: 1, 5, 6)
  - [ ] Test notifications when app is backgrounded for 30+ seconds
  - [ ] Test notifications when app is completely closed
  - [ ] Verify background task completion within iOS time limits
  - [ ] Test notification delivery with multiple rapid messages
  - [ ] Validate no performance impact on foreground app usage

## Dev Notes

**Previous Story Context:**
From Story 3.4 (Done), we have a complete NotificationManager implementation with:
- Local notification scheduling via UNUserNotificationCenter
- In-app banner notifications for foreground state
- Firestore listeners for new message detection
- Proper notification permission handling
- Navigation from notifications to conversations

**Current Project State:**
Epic 5 (AI-Powered Messaging Features) is **complete** - all stories 5.0 through 5.6 are Done. The app now has:
- Full AI backend with Python/FastAPI/LangChain
- Event, Reminder, and Decision management
- Calendar integration and RSVP tracking
- Priority message highlighting
- Proactive assistant capabilities
- Complete notification system for AI-generated reminders

**Integration Considerations:**
This background notification refinement must work seamlessly with the existing AI notification system from Story 5.5 (Reminder Extraction), which already schedules local notifications for AI-detected reminders. The background task system should handle both regular message notifications AND AI-generated reminder notifications.

**Current Implementation Gap:**
The existing NotificationManager assumes Firestore listeners continue working in background, but iOS suspends apps after ~30 seconds, stopping Firestore listeners. This means notifications only work when app is foregrounded or recently backgrounded.

**Technical Solution:**
1. **Background App Refresh**: Enable iOS capability to keep app running in background
2. **Background Tasks**: Use BGAppRefreshTask to extend Firestore listener lifetime
3. **Task Management**: Properly handle iOS execution time limits (typically 30 seconds)
4. **Fallback Strategy**: Graceful degradation when background execution expires

**Key Technical Details:**

**Background Task Registration:**
```swift
// In NotificationManager
private func registerBackgroundTask() {
    let request = BGAppRefreshTaskRequest(identifier: "com.jpw.message-ai.notifications")
    request.earliestBeginDate = Date(timeIntervalSinceNow: 15 * 60) // 15 minutes
    
    try? BGTaskScheduler.shared.submit(request)
}
```

**Background Task Handler:**
```swift
// In AppDelegate
func application(_ application: UIApplication, performFetchWithCompletionHandler completionHandler: @escaping (UIBackgroundFetchResult) -> Void) {
    // Extend Firestore listener lifetime
    notificationManager.handleBackgroundRefresh { result in
        completionHandler(result)
    }
}
```

**Firestore Listener Extension:**
```swift
// In NotificationManager
func handleBackgroundRefresh(completion: @escaping (UIBackgroundFetchResult) -> Void) {
    // Keep existing listeners active
    // Process any pending notifications
    // Complete within iOS time limit
}
```

**Testing Strategy:**
- Test with app backgrounded for various durations (30s, 2min, 5min)
- Test with app completely closed
- Verify notifications appear on lock screen
- Test battery usage impact
- Validate iOS Settings shows Background App Refresh enabled

**Architecture Integration:**
- Extends existing NotificationManager without breaking changes
- Maintains compatibility with current notification suppression logic
- Preserves existing in-app banner functionality
- No changes required to Firestore listeners or message handling

**Performance Considerations:**
- Background tasks limited to 30 seconds by iOS
- Minimal CPU usage during background execution
- Efficient task scheduling to avoid battery drain
- Proper cleanup when background execution expires

## Testing

**Manual Testing Required:**
- Background app for 30+ seconds, send message from another device
- Close app completely, send message, verify notification appears
- Test AI-generated reminder notifications work in background (Story 5.5)
- Test with Background App Refresh disabled in iOS Settings
- Verify battery usage remains minimal
- Test rapid message delivery in background state
- Test both regular message notifications AND AI reminder notifications

**Success Criteria:**
- Notifications work reliably when app is backgrounded or closed
- Background App Refresh capability visible in iOS Settings
- No performance impact on foreground app usage
- Proper handling of iOS execution time limits

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation for background notification refinement | SM |
