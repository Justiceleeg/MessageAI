# Story 5.1.5: Calendar & Reminders UI

**Epic:** 5 - AI-Powered Messaging Features  
**Story Points:** 5  
**Priority:** High  
**Assigned To:** @dev  
**Status:** Not Started

---

## User Story

**As a** user with events and reminders,  
**I want** a visual calendar interface to see all my upcoming commitments,  
**so that** I can stay organized and quickly access what I've planned.

---

## Description

Create a comprehensive Calendar view that displays events and reminders in a beautiful, intuitive interface using the Mijick CalendarView library. This view serves as the central hub for all AI-extracted events and reminders, with navigation back to source messages and real-time updates from Firestore.

The calendar includes:
- **Events tab:** Grid calendar view showing events by date
- **Reminders tab:** List view showing upcoming reminders
- Navigation to/from conversations
- Real-time synchronization
- Deep linking to source messages

---

## Acceptance Criteria

### AC1: Mijick CalendarView Integration
- [ ] Add Mijick CalendarView via Swift Package Manager
- [ ] Package URL: `https://github.com/Mijick/CalendarView`
- [ ] Verify package builds without errors
- [ ] No conflicts with existing dependencies
- [ ] Library properly imported in relevant views

### AC2: Calendar Screen Structure
- [ ] Create `CalendarView.swift` as main screen
- [ ] Tab bar navigation: [Events] [Reminders]
- [ ] Header shows current month/year
- [ ] Navigation bar with title "Calendar"
- [ ] Accessible from ConversationListView (new tab or navigation)
- [ ] Consistent with app's design system

### AC3: Events Calendar Grid Display
- [ ] Mijick CalendarView configured to show monthly grid
- [ ] Events displayed as dots/badges on calendar dates
- [ ] Multiple events on same day show count badge
- [ ] Tapping date shows events for that day
- [ ] Scrollable month-to-month
- [ ] Events fetched from EventService
- [ ] Real-time updates when new events created

### AC4: Event Day View
- [ ] Tapping calendar date shows all events for that day
- [ ] List view below calendar grid (or modal sheet)
- [ ] Each event shows:
  - Title
  - Time (if specified)
  - Location (if specified)
  - Attendee count
- [ ] Tapping event opens Event Detail View
- [ ] Empty state: "No events on this day"

### AC5: Event Detail View
- [ ] Full-screen modal or navigation push
- [ ] Displays complete event information:
  - Title, Date, Time, Location
  - Creator name
  - List of attendees with RSVP status (pending/accepted/declined)
  - Which conversation it was created in
- [ ] "Jump to Message" button
  - Navigates to conversation
  - Scrolls to source message
  - Highlights message briefly
- [ ] "Edit Event" button (future - can be stubbed)
- [ ] "Delete Event" button (confirmation alert)
- [ ] Close button

### AC6: Reminders Tab Display
- [ ] Switch to Reminders tab shows list view (not calendar grid)
- [ ] Reminders grouped by time:
  - **Overdue** (red badge)
  - **Today**
  - **Tomorrow**
  - **This Week**
  - **Later**
- [ ] Each reminder shows:
  - Title
  - Due date/time
  - Conversation name
  - Checkbox for completion
- [ ] Swipe actions:
  - Swipe left: Delete
  - Swipe right: Mark complete
- [ ] Completed reminders shown in separate "Completed" section (collapsible)
- [ ] Empty state: "No reminders set"

### AC7: Reminder Detail View
- [ ] Tapping reminder opens detail modal
- [ ] Displays:
  - Title
  - Due date/time
  - Conversation name
  - Completion status
- [ ] "Jump to Message" button (same as events)
- [ ] "Mark Complete" toggle
- [ ] "Delete Reminder" button
- [ ] Close button

### AC8: Real-time Updates
- [ ] Events update when created/modified in conversations
- [ ] Reminders update when created/completed
- [ ] Use Firestore listeners via EventService/ReminderService
- [ ] Calendar view refreshes automatically
- [ ] No manual refresh needed
- [ ] Handle listener lifecycle (attach on appear, detach on disappear)

### AC9: Navigation Integration
- [ ] Add Calendar icon to ConversationListView navigation
  - Tab bar item (if using tab bar) OR
  - Navigation bar button (if using navigation stack)
- [ ] Tapping opens CalendarView
- [ ] From Event/Reminder detail → Conversation: proper navigation stack
- [ ] Back navigation maintains context
- [ ] Deep linking: Opening app with event ID navigates correctly

### AC10: Empty States & Error Handling
- [ ] Empty state when no events exist (friendly message)
- [ ] Empty state when no reminders exist
- [ ] Loading states while fetching data
- [ ] Error state if Firestore fails (retry option)
- [ ] Offline state (show cached data with indicator)

---

## Tasks

### Task 1: Mijick CalendarView Integration (AC1)
- [ ] Add Swift Package dependency
- [ ] Resolve package in Xcode
- [ ] Import library in test view
- [ ] Verify builds successfully
- [ ] Review library documentation

### Task 2: Calendar Screen Structure (AC2)
- [ ] Create `CalendarView.swift`
- [ ] Set up TabView with [Events] [Reminders] tabs
- [ ] Add navigation bar title
- [ ] Style consistent with app theme
- [ ] Add to navigation from ConversationListView

### Task 3: Events Calendar Grid (AC3, AC4)
- [ ] Integrate Mijick CalendarView component
- [ ] Configure monthly grid display
- [ ] Fetch events from EventService
- [ ] Map events to calendar dates
- [ ] Show event indicators on dates
- [ ] Implement date selection
- [ ] Create Event Day List View
- [ ] Wire up real-time listener

### Task 4: Event Detail View (AC5)
- [ ] Create `EventDetailView.swift`
- [ ] Layout all event fields
- [ ] Display attendee list with RSVP statuses
- [ ] Implement "Jump to Message" navigation
  - Navigate to ChatView with conversationId
  - Pass messageId for scroll-to
  - Trigger highlight animation
- [ ] Implement delete event action
- [ ] Handle confirmation alerts

### Task 5: Reminders Tab (AC6)
- [ ] Create `RemindersListView.swift`
- [ ] Fetch reminders from ReminderService
- [ ] Group by time buckets (Overdue, Today, etc.)
- [ ] Display in sectioned list
- [ ] Implement swipe actions (complete/delete)
- [ ] Show completion checkbox
- [ ] Wire up real-time listener
- [ ] Handle empty state

### Task 6: Reminder Detail View (AC7)
- [ ] Create `ReminderDetailView.swift`
- [ ] Layout reminder fields
- [ ] Implement "Jump to Message" navigation
- [ ] Implement "Mark Complete" toggle
  - Call ReminderService.markComplete()
  - Update UI immediately
- [ ] Implement delete reminder action

### Task 7: Real-time Updates (AC8)
- [ ] Set up Firestore listeners in CalendarView
- [ ] Attach listeners onAppear
- [ ] Detach listeners onDisappear
- [ ] Handle event updates (create/modify/delete)
- [ ] Handle reminder updates (create/complete/delete)
- [ ] Test multi-device sync

### Task 8: Navigation Integration (AC9)
- [ ] Add Calendar tab/button to ConversationListView
- [ ] Configure navigation stack properly
- [ ] Implement deep linking from Event/Reminder → Conversation
- [ ] Test navigation flows:
  - List → Calendar → Event → Conversation → Message
  - List → Calendar → Reminder → Conversation → Message
- [ ] Ensure back navigation works correctly

### Task 9: Empty States & Error Handling (AC10)
- [ ] Create EmptyStateView component (if not exists)
- [ ] Add empty state for no events
- [ ] Add empty state for no reminders
- [ ] Add loading spinner while fetching
- [ ] Add error state with retry button
- [ ] Add offline indicator
- [ ] Test all states

### Task 10: Manual Testing (AC1-10)
- [ ] Test: Create event in chat → See in calendar
- [ ] Test: Tap event → See details → Jump to message
- [ ] Test: Delete event from calendar
- [ ] Test: Create reminder → See in calendar
- [ ] Test: Mark reminder complete → Moves to completed
- [ ] Test: Tap reminder → Jump to message
- [ ] Test: Real-time sync (create event in web, see in app)
- [ ] Test: Empty states for events and reminders
- [ ] Test: Navigation flows work correctly

---

## Technical Notes

### Mijick CalendarView Setup

```swift
// Add to Package.swift dependencies:
.package(url: "https://github.com/Mijick/CalendarView", from: "1.0.0")

// Import in CalendarView.swift:
import MijickCalendarView
```

### CalendarView Structure

```swift
// CalendarView.swift
import SwiftUI
import MijickCalendarView

struct CalendarView: View {
    @StateObject private var eventService = EventService()
    @StateObject private var reminderService = ReminderService()
    
    @State private var selectedTab: CalendarTab = .events
    @State private var events: [Event] = []
    @State private var reminders: [Reminder] = []
    @State private var selectedDate: Date = Date()
    
    enum CalendarTab {
        case events, reminders
    }
    
    var body: some View {
        VStack {
            // Tab selector
            Picker("View", selection: $selectedTab) {
                Text("Events").tag(CalendarTab.events)
                Text("Reminders").tag(CalendarTab.reminders)
            }
            .pickerStyle(.segmented)
            .padding()
            
            // Content based on selected tab
            if selectedTab == .events {
                EventsCalendarView(events: events, 
                                  selectedDate: $selectedDate,
                                  onEventTap: { event in
                                      // Show event detail
                                  })
            } else {
                RemindersListView(reminders: reminders,
                                 onReminderTap: { reminder in
                                     // Show reminder detail
                                 })
            }
        }
        .navigationTitle("Calendar")
        .onAppear {
            loadData()
            setupListeners()
        }
        .onDisappear {
            removeListeners()
        }
    }
    
    private func loadData() {
        Task {
            events = try await eventService.listEvents(userId: getCurrentUserId())
            reminders = try await reminderService.listReminders(userId: getCurrentUserId())
        }
    }
    
    private func setupListeners() {
        // Set up real-time listeners
    }
    
    private func removeListeners() {
        // Clean up listeners
    }
}
```

### Event Indicators on Calendar

```swift
// EventsCalendarView.swift
struct EventsCalendarView: View {
    let events: [Event]
    @Binding var selectedDate: Date
    var onEventTap: (Event) -> Void
    
    var body: some View {
        VStack {
            // Mijick CalendarView
            MJCalendarView(selectedDate: $selectedDate)
                .calendarStyle(.month)
                .markedDates(getEventDates())
                .onDateSelected { date in
                    selectedDate = date
                }
            
            // Events for selected date
            EventDayListView(
                events: eventsForDate(selectedDate),
                onEventTap: onEventTap
            )
        }
    }
    
    private func getEventDates() -> [Date] {
        events.map { $0.date }
    }
    
    private func eventsForDate(_ date: Date) -> [Event] {
        events.filter { Calendar.current.isDate($0.date, inSameDayAs: date) }
    }
}
```

### Reminder Grouping Logic

```swift
// RemindersListView.swift
extension RemindersListView {
    func groupedReminders() -> [String: [Reminder]] {
        let now = Date()
        let calendar = Calendar.current
        
        var groups: [String: [Reminder]] = [:]
        
        for reminder in reminders.filter({ !$0.completed }) {
            let group: String
            
            if reminder.dueDate < now {
                group = "Overdue"
            } else if calendar.isDateInToday(reminder.dueDate) {
                group = "Today"
            } else if calendar.isDateInTomorrow(reminder.dueDate) {
                group = "Tomorrow"
            } else if calendar.isDate(reminder.dueDate, equalTo: now, toGranularity: .weekOfYear) {
                group = "This Week"
            } else {
                group = "Later"
            }
            
            groups[group, default: []].append(reminder)
        }
        
        return groups
    }
}
```

### Navigation to Message

```swift
// EventDetailView.swift or ReminderDetailView.swift
Button("Jump to Message") {
    navigateToMessage(
        conversationId: event.createdInConversationId,
        messageId: event.createdAtMessageId
    )
}

func navigateToMessage(conversationId: String, messageId: String) {
    // Navigate to ConversationListView
    // Find conversation
    // Open ChatView for that conversation
    // Scroll to messageId
    // Highlight message
    
    // This requires NavigationPath or similar navigation coordination
}
```

---

## Definition of Done

- [ ] All acceptance criteria met (AC1-10)
- [ ] All tasks completed (Tasks 1-10)
- [ ] Mijick CalendarView integrated and working
- [ ] Events displayed in calendar grid
- [ ] Reminders displayed in list view
- [ ] Event detail view implemented
- [ ] Reminder detail view implemented
- [ ] Real-time updates working
- [ ] Navigation to/from messages working
- [ ] Empty states and error handling implemented
- [ ] Manual testing passed
- [ ] Code reviewed and follows standards
- [ ] No crashes or UI glitches

---

## Dependencies

**Upstream:** 
- Story 5.0.5 (iOS Data Models & Services - Event/Reminder models required)
- Story 5.1 (Smart Calendar Extraction - creates events to display)

**Downstream:** 
- Story 5.5 (Reminder Extraction - creates reminders to display)

---

## Testing Strategy

### Manual Test Cases (Primary Validation)

1. **Calendar Grid Display**
   - Open Calendar view
   - Expected: Current month shown
   - See events as indicators on dates
   - Scroll to next month → Previous month

2. **Event Display**
   - Tap date with events
   - Expected: List of events for that day appears
   - Tap event → Event detail opens
   - All fields displayed correctly

3. **Jump to Message from Event**
   - In event detail, tap "Jump to Message"
   - Expected: Navigate to conversation
   - Scroll to source message
   - Message briefly highlighted

4. **Reminders Tab**
   - Switch to Reminders tab
   - Expected: Reminders grouped by time
   - Overdue items show red badge
   - Swipe reminder → Mark complete
   - Expected: Moves to Completed section

5. **Jump to Message from Reminder**
   - Tap reminder → Detail opens
   - Tap "Jump to Message"
   - Expected: Navigate to source message

6. **Real-time Sync**
   - Create event in chat
   - Go to Calendar view
   - Expected: Event appears immediately
   - Create reminder in chat
   - Switch to Reminders tab
   - Expected: Reminder appears immediately

7. **Delete Operations**
   - Delete event from calendar
   - Expected: Removed from view and Firestore
   - Delete reminder
   - Expected: Removed from view and Firestore

8. **Empty States**
   - Delete all events
   - Expected: "No events" message
   - Delete all reminders
   - Expected: "No reminders" message

### Unit Testing (Optional)
Unit tests for grouping logic and date calculations may be created but are not required.

**Note:** This story will rely on manual testing for end-to-end validation. Unit tests are optional and may be skipped to meet timeline constraints.

---

## Notes

- Mijick CalendarView is MIT licensed (approved in briefing)
- Calendar is central hub for all AI-extracted commitments
- Real-time sync is critical for good UX
- Navigation to source messages creates "traceability" feature
- Empty states should be friendly and encouraging
- Consider adding "Add Event" button for manual creation (future enhancement)

---

## References

- AI Features Briefing: Lines 296-308 (Mijick CalendarView approval)
- Story 5.0.5: Event and Reminder models
- Story 5.1: Event creation flow
- Story 5.5: Reminder creation flow
- Mijick CalendarView Docs: https://github.com/Mijick/CalendarView

---

**Story 5.1.5 provides the visual interface for all AI-extracted commitments, making the invisible AI work tangible and useful.**

